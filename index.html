<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Despire</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ----------------- AMBIANCE G√âN√âRALE ----------------- */
body 
{
    margin: 0;
    font-family: "Georgia", serif;
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #2f3e34;
    overflow-x: hidden;
}

h1,h2,h3 {
    font-weight: normal;
}

/* ----------------- LOGIN ----------------- */
#login {
    position: fixed;
    inset: 0;
    background: rgba(245,245,240,0.98);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    transition: opacity 3s cubic-bezier(0.4, 0, 0.2, 1); 
}

#login.fade-out {
    opacity: 0;
    pointer-events: none;
}

#loginBox {
    background: rgba(255,255,255,0.85);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

#loginBox input {
    padding: 14px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid #aaa;
    font-size: 16px;
}

#loginBox button {
    margin-top: 20px;
    padding: 14px 30px;
    border: none;
    border-radius: 30px;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* ----------------- THERMOM√àTRE D'√âNERGIE AM√âLIOR√â ----------------- */
#thermo-container {
    position: absolute;
    left: 20px;
    top: 20px;
    z-index: 100;
    display: none;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transition: opacity 1.5s ease-in-out;
}

#thermo-container.visible {
    display: flex;
    opacity: 1;
}

/* Le tube du thermom√®tre */
#thermo-cadre {
    width: 18px;
    height: 160px;
    background: linear-gradient(to right, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.6) 50%, 
        rgba(255,255,255,0.4) 100%
    );
    backdrop-filter: blur(8px);
    border: 2px solid rgba(47,62,52,0.3);
    border-radius: 12px 12px 0 0;
    position: relative;
    overflow: hidden;
    box-shadow: 
        inset -2px 0 4px rgba(0,0,0,0.1),
        inset 2px 0 4px rgba(255,255,255,0.3);
    border-bottom: none;
}
    /* Le liquide qui monte DE BAS EN HAUT */
#thermo-niveau {
    position: absolute;
    bottom: 0;  /* ‚úÖ CORRIG√â - ancr√© en bas */
    left: 0;
    width: 100%;
    height: 0%;
    background: linear-gradient(to top,
        #e74c3c 0%,      /* Rouge en bas */
        #f39c12 50%,     /* Orange au milieu */
        #2ecc71 100%     /* Vert en haut */
    );
    transition: height 3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: visible;
}


/* Vague √† la surface du liquide */
.wave {
    position: absolute;
    top: -8px;
    left: -100%;
    width: 300%;
    height: 16px;
    background: radial-gradient(ellipse at center, 
        rgba(255,255,255,0.4) 0%, 
        transparent 70%
    );
    border-radius: 50%;
    animation: wave-motion 3s ease-in-out infinite;
}

@keyframes wave-motion {
    0%, 100% {
        transform: translateX(0) translateY(0);
    }
    25% {
        transform: translateX(10%) translateY(-2px);
    }
    50% {
        transform: translateX(0) translateY(0);
    }
    75% {
        transform: translateX(-10%) translateY(-2px);
    }
}

/* Bulles anim√©es */
.bubble {
    position: absolute;
    background: rgba(255,255,255,0.6);
    border-radius: 50%;
    animation: bubble-rise linear infinite;
    box-shadow: inset -1px -1px 2px rgba(0,0,0,0.1);
}

.bubble:nth-child(2) {
    width: 3px;
    height: 3px;
    left: 25%;
    animation-duration: 4s;
    animation-delay: 0s;
}

.bubble:nth-child(3) {
    width: 4px;
    height: 4px;
    left: 60%;
    animation-duration: 5s;
    animation-delay: 1.2s;
}

.bubble:nth-child(4) {
    width: 2px;
    height: 2px;
    left: 45%;
    animation-duration: 3.5s;
    animation-delay: 2s;
}

@keyframes bubble-rise {
    0% {
        bottom: 0;
        opacity: 0;
        transform: scale(0.8);
    }
    10% {
        opacity: 1;
    }
    80% {
        opacity: 0.8;
    }
    100% {
        bottom: 100%;
        opacity: 0;
        transform: scale(1.2);
    }
}

/* R√©servoir en bas (boule rouge) */
#thermo-reservoir {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, 
        #e74c3c 0%, 
        #c0392b 100%
    );
    border: 2px solid rgba(47,62,52,0.3);
    border-radius: 50%;
    margin-top: -3px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 
        inset -3px -3px 6px rgba(0,0,0,0.2),
        inset 3px 3px 6px rgba(255,100,100,0.3),
        0 2px 8px rgba(231,76,60,0.3);
}

/* Reflet lumineux sur le r√©servoir */
#thermo-reservoir::before {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    width: 10px;
    height: 10px;
    background: radial-gradient(circle, 
        rgba(255,255,255,0.6) 0%, 
        transparent 70%
    );
    border-radius: 50%;
}

#thermo-label {
    font-family: "Georgia", serif;
    font-size: 11px;
    font-weight: bold;
    margin-top: 6px;
    color: #2f3e34;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ----------------- PAGE PRINCIPALE ----------------- */
#main {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    min-height: 100vh;
    box-sizing: border-box;
    animation: fadeIn 1.2s ease-out;
    position: relative;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInTitle {
    from { 
        opacity: 0; 
        transform: translateY(-20px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeInVaporeux {
    0% { 
        opacity: 0;
        filter: blur(15px);
        transform: scale(0.98);
    }
    100% { 
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
    }
}

#main h2 {
    font-size: 1.1rem; 
    line-height: 1.5;
    text-align: center;
    margin: 10px auto 20px auto;
    padding: 20px 20px 20px 70px;
    width: 90%;
    max-width: 600px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    color: #2f3e34;
    opacity: 0;
    animation: fadeInTitle 3.5s ease-out 1.5s forwards;
}

/* ----------------- JARDIN RESPONSIVE ----------------- */
#garden {
    position: relative;
    width: 100%;
    max-width: 900px;
    height: 65vh;
    min-height: 400px;
    border-radius: 30px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
    overflow: hidden;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.05);
    opacity: 0;
    filter: blur(15px);
    animation: fadeInVaporeux 4s ease-out 1s forwards;
}

/* ----------------- BOUTON AJOUT CENTR√â ----------------- */
#addBtn {
    display: block;
    margin: 20px auto;
    padding: 14px 30px;
    border-radius: 40px;
    border: none;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
    opacity: 0;
    animation: fadeIn 2s ease-in-out 1.5s forwards;
}

#addBtn:hover {
    transform: scale(1.05);
}

#quote {
    text-align: center;
    font-style: italic;
    opacity: 0.8;
    margin-bottom: 30px;
}

/* Message de remerciement */
#thankYouMsg {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(139,191,159,0.95);
    color: white;
    padding: 30px 50px;
    border-radius: 20px;
    font-size: 20px;
    text-align: center;
    z-index: 150;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 80%;
}

#thankYouMsg.show {
    transform: translate(-50%, -50%) scale(1);
}

.plant-container {
    position: absolute;
}

.plant {
    animation: breathe 10s ease-in-out infinite;
    cursor: pointer;
    transition: transform 0.5s ease, filter 0.3s ease;
    position: relative;
}

.plant.arbre, .plant.arbuste {
    transform-origin: bottom center;
}

.plant.fleur, .plant.fruit {
    transform-origin: center center;
}

.plant.oiseau, .plant.papillon {
    transform-origin: center center;
}

.plant:hover {
    filter: brightness(1.1) drop-shadow(0 0 15px rgba(139,191,159,0.6));
}

/* Cercle de mise en valeur */
.highlight-circle {
    position: absolute;
    border: 4px solid #ffd782;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
    pointer-events: none;
    box-shadow: 0 0 20px rgba(255,215,130,0.8);
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
        opacity: 1;
    }
    50% { 
        transform: scale(1.15);
        opacity: 0.7;
    }
}

@keyframes breathe {
    0%,100% { transform: scale(var(--scale, 1)); }
    50% { transform: scale(calc(var(--scale, 1) * 1.1)); }
}

/* ----------------- FORMULAIRE AJOUT ----------------- */
#overlay {
    position: fixed;
    inset: 0;
    background: rgba(250,250,245,0.96);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 90;
}

form {
    background: white;
    padding: 40px;
    border-radius: 25px;
    width: 420px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
}

form select, form textarea, form input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 12px;
    border: 1px solid #ccc;
}

form button {
    margin-top: 20px;
    padding: 14px;
    width: 100%;
    border-radius: 30px;
    border: none;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* ----------------- CARNET DE JARDINIER ----------------- */
#notebook {
    position: fixed;
    right: -100%;
    top: 0;
    bottom: 0;
    width: 100%;
    max-width: 550px;
    background: linear-gradient(to right, #8b7355 0%, #8b7355 20px, #f9f7f1 20px);
    box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    z-index: 150;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

#notebook.open {
    right: 0;
}

#notebook::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 40px;
    bottom: 40px;
    width: 12px;
    background: repeating-linear-gradient(
        to bottom,
        transparent 0px,
        transparent 15px,
        #6b5d4f 15px,
        #6b5d4f 20px,
        transparent 20px,
        transparent 35px
    );
    border-radius: 2px;
}

#notebookContent {
    margin-left: 30px;
    padding: 40px 30px 100px 20px;
    height: 100%;
    overflow-y: auto;
    background: 
        repeating-linear-gradient(
            transparent,
            transparent 31px,
            #e8dcc8 31px,
            #e8dcc8 32px
        ),
        #f9f7f1;
    box-sizing: border-box;
}

#closeNotebook {
    position: absolute;
    right: 20px;
    top: 20px;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6fa58c;
    z-index: 1;
    transition: transform 0.2s;
}

#closeNotebook:hover {
    transform: rotate(90deg);
}

.notebook-page {
    margin-bottom: 60px;
    padding-bottom: 30px;
    border-bottom: 2px dashed #d4c5b0;
    line-height: 32px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 3px solid #6fa58c;
}

.page-date {
    font-size: 14px;
    color: #8b7355;
    font-style: italic;
}

.page-number {
    background: #6fa58c;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
}

.notebook-section {
    margin: 20px 0;
}

.section-label {
    font-weight: bold;
    color: #6fa58c;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.section-content {
    color: #2f3e34;
    font-size: 15px;
    padding-left: 10px;
}

.interaction-stats {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: rgba(139,191,159,0.1);
    border-radius: 8px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

.water-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: rgba(139,191,159,0.15);
    border-radius: 12px;
    justify-content: center;
}

.water-btn {
    background: white;
    border: 2px solid #6fa58c;
    padding: 12px 20px;
    border-radius: 30px;
    cursor: pointer;
    font-size: 32px;
    transition: all 0.3s;
}

.water-btn:hover:not(:disabled) {
    background: #6fa58c;
    transform: scale(1.1);
}

.water-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    border-color: #ccc;
}

.water-btn.used {
    background: #d0e8d0;
    border-color: #8bbf9f;
}

#pageNav {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px 20px;
    border-radius: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

#pageNav button {
    background: #6fa58c;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
}

#pageNav button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#pageInfo {
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: #6fa58c;
    font-weight: bold;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #6fa58c;
}

/* ----------------- ADAPTATION MOBILE ----------------- */
@media (max-width: 600px) {
    #main {
        padding: 15px;
    }

    #garden {
        height: 70vh;
        min-height: 400px;
    }

    #main h2 {
        font-size: 0.95rem;
        padding: 18px 18px 18px 65px;
    }

    #addBtn {
        padding: 12px 24px;
        font-size: 16px;
    }

    #thermo-container {
        left: 12px;
        top: 18px;
        transform: scale(0.9);
    }

    form {
        width: 90%;
        max-width: 420px;
    }
}

@media (max-height: 500px) {
    #garden {
        height: 300px;
    }
}
</style>

</head>

<body>

<div id="login">
    <div id="loginBox">
        <h2>üå± KaroOburo</h2>
        <p>Entre dans le jardin</p>
        <input id="pwd" type="password" placeholder="mot de passe">
        <button onclick="checkPassword()">Entrer</button>
    </div>
</div>

<div id="main">
    <!-- Thermom√®tre positionn√© en haut √† gauche -->
    <div id="thermo-container">
        <div id="thermo-cadre">
            <div id="thermo-niveau">
                <div class="wave"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
            </div>
        </div>
        <div id="thermo-reservoir"></div>
        <div id="thermo-label">√ânergie</div>
    </div>

```
<h2>
    Si nou s√®m brinzell nou sa pa k√©yir babafig / <br>
    si nou plant' banann' nou sa pa manz' kaviar ! <br> 
    Al√© tir in feuye / r√©colt leu tempo !
</h2>

<div id="quote"></div>

<button id="addBtn" onclick="openForm()">‚ûï Planter une exp√©rience</button>

<div id="garden">
    <div class="loading">üå± Chargement du jardin...</div>
</div>
```

</div>

<div id="thankYouMsg"></div>

<div id="overlay">
<form id="form">
  <h3>üåø Planter une exp√©rience</h3>

  <select name="activite" required>
    <option value="">Contexte / activit√©</option>
    <option>Soin / accompagnement</option>
    <option>√âchange / relation</option>
    <option>Cr√©ation / r√©flexion</option>
    <option>Transmission</option>
    <option>Autre</option>
  </select>

  <textarea name="experience"
   placeholder="D√©cris l'exp√©rience v√©cue, simplement‚Ä¶"
   required></textarea>

  <textarea name="ressenti"
   placeholder="Ce que cela a provoqu√©, appris, transform√©‚Ä¶"></textarea>

  <select name="force">
    <option value="">Force mobilis√©e (VIA)</option>
    <optgroup label="üß† SAGESSE ET CONNAISSANCE">
      <option>Curiosit√©</option>
      <option>Amour de l'apprentissage</option>
      <option>Jugement / Pens√©e critique</option>
      <option>Ing√©niosit√© / Cr√©ativit√©</option>
      <option>Perspective / Sagesse</option>
    </optgroup>
    <optgroup label="üí™ COURAGE">
      <option>Bravoure</option>
      <option>Pers√©v√©rance</option>
      <option>Int√©grit√© / Honn√™tet√©</option>
      <option>Enthousiasme</option>
    </optgroup>
    <optgroup label="‚ù§Ô∏è HUMANIT√â">
      <option>Amour</option>
      <option>Gentillesse</option>
      <option>Intelligence sociale / Empathie</option>
    </optgroup>
    <optgroup label="‚öñÔ∏è JUSTICE">
      <option>√âquit√©</option>
      <option>Leadership</option>
      <option>Travail d'√©quipe / Esprit de citoyennet√©</option>
    </optgroup>
    <optgroup label="üßò TEMP√âRANCE">
      <option>Pardon / Indulgence</option>
      <option>Humilit√© / Modestie</option>
      <option>Prudence / Pr√©venance</option>
      <option>Autocontr√¥le / R√©gulation de soi</option>
    </optgroup>
    <optgroup label="‚ú® TRANSCENDANCE">
      <option>Appr√©ciation de la beaut√© et de l'excellence</option>
      <option>Gratitude</option>
      <option>Espoir / Optimisme</option>
      <option>Humour</option>
      <option>Spiritualit√© / Foi</option>
    </optgroup>
  </select>

  <input name="forceLibre" placeholder="Autre force (si diff√©rente)">

  <select name="valeur">
    <option value="">Valeur en jeu (Schwartz)</option>
    <optgroup label="üåç OUVERTURE AU CHANGEMENT">
      <option>Autod√©termination-pens√©e</option>
      <option>Autod√©termination-action</option>
      <option>Stimulation</option>
      <option>H√©donisme</option>
    </optgroup>
    <optgroup label="üéØ CROISSANCE PERSONNELLE">
      <option>R√©alisation</option>
      <option>Pouvoir-dominance</option>
      <option>Pouvoir-ressources</option>
    </optgroup>
    <optgroup label="üõ°Ô∏è CONSERVATION">
      <option>Image publique</option>
      <option>S√©curit√©-personnel</option>
      <option>Tradition</option>
      <option>Conformit√©-r√®gles</option>
      <option>Conformit√©-interpersonnelle</option>
      <option>Humilit√©</option>
    </optgroup>
    <optgroup label="üíó D√âPASSEMENT DE SOI">
      <option>Bienveillance-soins</option>
      <option>Bienveillance-fiabilit√©</option>
      <option>Universalisme-pr√©occupation</option>
      <option>Universalisme-nature</option>
      <option>Universalisme-tol√©rance</option>
    </optgroup>
  </select>

  <input name="pourQui" placeholder="Pour qui cette exp√©rience a compt√© ?">

<button type="submit">üå∏ Planter</button>

</form>
</div>

<div id="notebook">
    <button id="closeNotebook" onclick="closeNotebook()">‚úï</button>
    <div id="notebookContent"></div>
    <div id="pageNav">
        <button onclick="prevPage()" id="prevBtn">‚Üê Pr√©c√©dent</button>
        <div id="pageInfo"></div>
        <button onclick="nextPage()" id="nextBtn">Suivant ‚Üí</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyADBlPY8lK_52mFTWWHdoEBcPXa4Dk3FVA",
    authDomain: "jardin-3f127.firebaseapp.com",
    databaseURL: "https://jardin-3f127-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jardin-3f127",
    storageBucket: "jardin-3f127.firebasestorage.app",
    messagingSenderId: "371927426307",
    appId: "1:371927426307:web:dba165b1aaf4b8179e3536"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const plantsRef = ref(database, 'plants');

  window.db = database;
  window.plantsRef = plantsRef;

  const PASSWORD = "jardin";
  const NIVEAU_ENERGIE = 75;

  const quotes = [
      "Ce √† quoi tu pr√™tes attention grandit.",
      "Chaque geste nourrit une racine invisible.",
      "Le vivant se cultive par la pr√©sence.",
      "Un jardin est une m√©moire qui respire."
  ];

  const thankYouMessages = [
      "üå± Une nouvelle graine prend racine dans notre jardin collectif !",
      "‚ú® Merci pour cette belle contribution, elle fera grandir notre √©cosyst√®me !",
      "üå∏ Quelle fiert√© de voir le jardin s'√©panouir gr√¢ce √† toi !",
      "üåø Ta plantation enrichit la biodiversit√© de notre espace partag√© !",
      "üå≥ Chaque exp√©rience plant√©e nourrit la for√™t de nos apprentissages !",
      "üíö Gratitude pour ce don √† la terre commune, il portera ses fruits !",
      "üåæ Ta contribution s'enracine et inspirera d'autres jardiniers !",
      "ü™¥ Merci de cultiver avec nous cet espace de croissance mutuelle !",
      "üå∫ Belle plantation ! Le jardin te remercie de ta pr√©sence attentive !",
      "üçÉ Chaque plante ajout√©e tisse un peu plus notre √©cosyst√®me vivant !"
  ];

  const plantTypes = {
    arbre: [
      "assets/plants/arbre1.png",
      "assets/plants/arbre2.png",
      "assets/plants/arbre3.png"
    ],
    arbuste: [
      "assets/plants/arbuste1.png",
      "assets/plants/arbuste2.png",
      "assets/plants/arbuste3.png"
    ],
    fleur: [
      "assets/plants/fleur1.png",
      "assets/plants/fleur2.png",
      "assets/plants/fleur3.png",
      "assets/plants/fleur4.png"
    ],
    fruit: [
      "assets/plants/fruit1.png",
      "assets/plants/fruit2.png",
      "assets/plants/fruit3.png"
    ],
    oiseau: [
      "assets/plants/oiseau1.png",
      "assets/plants/oiseau2.png",
      "assets/plants/oiseau3.png"
    ],
    papillon: [
      "assets/plants/papillon1.png",
      "assets/plants/papillon2.png",
      "assets/plants/papillon3.png"
    ]
  };

  const backgrounds = [
    "assets/bg-paper.jpg",
    "assets/bg1.jpg",
    "assets/bg2.jpg",
    "assets/bg3.jpg",
    "assets/bg4.jpg"
  ];

  let data = [];
  let currentPage = 0;
  let sessionWatered = {};

  function setRandomBackground() {
    const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBg}')`;
  }

  function showThankYouMessage() {
    const msg = thankYouMessages[Math.floor(Math.random() * thankYouMessages.length)];
    const msgEl = document.getElementById('thankYouMsg');
    msgEl.textContent = msg;
    msgEl.classList.add('show');
    
    setTimeout(() => {
      msgEl.classList.remove('show');
    }, 4000);
  }

  window.checkPassword = function() {
    const pwd = document.getElementById('pwd');
    const login = document.getElementById('login');
    const main = document.getElementById('main');
    const thermo = document.getElementById('thermo-container');
    const niveau = document.getElementById('thermo-niveau');

    if (pwd.value === PASSWORD) {
        setRandomBackground();
        loadPlants();
        quote.innerText = quotes[Math.floor(Math.random()*quotes.length)];

        main.style.display = "flex";
        
        setTimeout(() => {
            thermo.classList.add('visible');
        }, 500);
        
        setTimeout(() => {
            niveau.style.height = NIVEAU_ENERGIE + "%";
        }, 1500);

        login.classList.add('fade-out');
        setTimeout(() => {
            login.style.display = "none";
        }, 3000);
    } else {
        alert("Mot de passe incorrect");
    }
  }

  window.openForm = function() {
      overlay.style.display = "flex";
  }

  function loadPlants() {
      onValue(plantsRef, (snapshot) => {
          data = [];
          snapshot.forEach((childSnapshot) => {
              const plant = childSnapshot.val();
              plant.firebaseId = childSnapshot.key;
              data.push(plant);
          });
          
          data.sort((a, b) => b.id - a.id);
          renderGarden();
      });
  }

  function getRandomPlantType() {
    const types = ['arbre', 'arbuste', 'fleur', 'fruit', 'oiseau', 'papillon'];
    return types[Math.floor(Math.random() * types.length)];
  }

  function getPositionForType(type) {
    let x, y;
    
    switch(type) {
      case 'arbre':
      case 'arbuste':
        x = Math.random() * 85;
        y = 60 + Math.random() * 35;
        break;
        
      case 'fleur':
      case 'fruit':
        x = Math.random() * 85;
        y = 35 + Math.random() * 60;
        break;
        
      case 'oiseau':
      case 'papillon':
        x = Math.random() * 85;
        y = Math.random() * 66;
        break;
        
      default:
        x = Math.random() * 85;
        y = Math.random() * 75;
    }
    
    return { x, y };
  }

  function findNonOverlappingPosition(type) {
      const maxAttempts = 50;
      const minDistance = 10;
      
      for (let attempt = 0; attempt < maxAttempts; attempt++) {
          const pos = getPositionForType(type);
          
          let overlapping = false;
          for (let p of data) {
              const distance = Math.sqrt(
                  Math.pow(pos.x - p.x, 2) + Math.pow(pos.y - p.y, 2)
              );
              
              if (distance < minDistance) {
                  overlapping = true;
                  break;
              }
          }
          
          if (!overlapping) {
              return pos;
          }
      }
      
      return getPositionForType(type);
  }

  form.addEventListener("submit", e => {
      e.preventDefault();
      const f = new FormData(form);
      
      const type = getRandomPlantType();
      const position = findNonOverlappingPosition(type);
      const typeImages = plantTypes[type];
      const randomImg = typeImages[Math.floor(Math.random() * typeImages.length)];
      
      const newPlant = {
          id: Date.now(),
          activite: f.get("activite"),
          experience: f.get("experience"),
          ressenti: f.get("ressenti"),
          force: f.get("force") || f.get("forceLibre"),
          valeur: f.get("valeur"),
          pourQui: f.get("pourQui"),
          type: type,
          img: randomImg,
          x: position.x,
          y: position.y,
          eau: 0,
          soleil: 0,
          date: new Date().toLocaleDateString("fr-FR")
      };
      
      push(plantsRef, newPlant);
      
      overlay.style.display = "none";
      form.reset();
      
      showThankYouMessage();
  });

  function renderGarden() {
      garden.innerHTML = "";
      
      if (data.length === 0) {
          garden.innerHTML = "<div class='loading'>üå± Le jardin est vide... Plante la premi√®re exp√©rience !</div>";
          return;
      }
      
      data.forEach((p, i) => {
          const container = document.createElement("div");
          container.className = "plant-container";
          container.style.left = p.x + "%";
          container.style.top = p.y + "%";
          
          const maxGrowth = (p.type === 'arbre' || p.type === 'arbuste') ? 10 : 5;
          const growthFactor = Math.min((p.eau || 0) + (p.soleil || 0), maxGrowth);
          const maxScale = (p.type === 'arbre' || p.type === 'arbuste') ? 2.0 : 1.5;
          const scale = 1 + (growthFactor / maxGrowth) * (maxScale - 1);
          
          const baseSize = 90;
          const size = baseSize * scale;
          
          const zIndex = i === 0 ? 20 : Math.round((100 - p.y) / 5);
          container.style.zIndex = zIndex;
          
          const img = document.createElement("img");
          img.src = p.img;
          img.alt = `Plante ${p.type}`;
          img.className = `plant ${p.type || 'fleur'}`;
          img.style.width = size + "px";
          img.style.setProperty('--scale', scale);
          img.onclick = () => openNotebook(i);
          
          container.appendChild(img);
          
          if (i === 0 && scale < 1.3) {
              const circle = document.createElement("div");
              circle.className = "highlight-circle";
              circle.style.width = (size + 20) + "px";
              circle.style.height = (size + 20) + "px";
              circle.style.left = "-10px";
              circle.style.top = "-10px";
              container.appendChild(circle);
          }
          
          garden.appendChild(container);
      });
  }

  window.openNotebook = function(index) {
    currentPage = index;
    notebook.classList.remove("open");

    setTimeout(() => {
        renderNotebook();
        notebook.classList.add("open");
    }, 40);
  }

  window.closeNotebook = function() {
      notebook.classList.remove("open");
  }

  window.waterPlant = function(plantId, type) {
      const sessionKey = `${plantId}_${type}`;
      
      if (sessionWatered[sessionKey]) {
          return;
      }
      
      const plant = data.find(p => p.firebaseId === plantId);
      if (!plant) return;
      
      if (type === 'water') {
          plant.eau = (plant.eau || 0) + 1;
      } else {
          plant.soleil = (plant.soleil || 0) + 1;
      }
      
      sessionWatered[sessionKey] = true;
      
      const plantRef = ref(database, 'plants/' + plantId);
      update(plantRef, { eau: plant.eau, soleil: plant.soleil });
      
      renderNotebook();
      renderGarden();
  }

  function renderNotebook() {
      if (data.length === 0) {
          notebookContent.innerHTML = "<p style='text-align:center; padding:40px;'>Aucune exp√©rience plant√©e pour l'instant...</p>";
          return;
      }
      
      const p = data[currentPage];
      const waterKey = `${p.firebaseId}_water`;
      const sunKey = `${p.firebaseId}_sun`;
      
      const maxGrowth = (p.type === 'arbre' || p.type === 'arbuste') ? 200 : 150;
      const maxInteractions = maxGrowth === 200 ? 10 : 5;
      const currentGrowth = Math.min(100 + (((p.eau || 0) + (p.soleil || 0)) / maxInteractions) * (maxGrowth - 100), maxGrowth);
      
      notebookContent.innerHTML = `
          <div class="notebook-page">
              <div class="page-header">
                  <div class="page-date">üìÖ ${p.date}</div>
                  <div class="page-number">Page ${currentPage + 1}/${data.length}</div>
              </div>
              
              <div class="notebook-section">
                  <div class="section-label">üåç Contexte</div>
                  <div class="section-content">${p.activite || "‚Äî"}</div>
              </div>
              
              <div class="notebook-section">
                  <div class="section-label">‚ú® Exp√©rience v√©cue</div>
                  <div class="section-content">${p.experience || "‚Äî"}</div>
              </div>
              
              ${p.ressenti ? `
              <div class="notebook-section">
                  <div class="section-label">üí≠ Ressenti & transformation</div>
                  <div class="section-content">${p.ressenti}</div>
              </div>
              ` : ''}
              
              ${p.force ? `
              <div class="notebook-section">
                  <div class="section-label">üí™ Force mobilis√©e</div>
                  <div class="section-content">${p.force}</div>
              </div>
              ` : ''}
              
              ${p.valeur ? `
              <div class="notebook-section">
                  <div class="section-label">‚≠ê Valeur en jeu</div>
                  <div class="section-content">${p.valeur}</div>
              </div>
              ` : ''}
              
              ${p.pourQui ? `
              <div class="notebook-section">
                  <div class="section-label">üë• Pour qui</div>
                  <div class="section-content">${p.pourQui}</div>
              </div>
              ` : ''}
              
              <div class="interaction-stats">
                  <div class="stat-item">üíß Eau : ${p.eau || 0}</div>
                  <div class="stat-item">‚òÄÔ∏è Soleil : ${p.soleil || 0}</div>
                  <div class="stat-item">üå± Croissance : ${Math.round(currentGrowth)}%</div>
              </div>
              
              <div class="water-actions">
                  <button class="water-btn ${sessionWatered[waterKey] ? 'used' : ''}" 
                          onclick="waterPlant('${p.firebaseId}', 'water')"
                          ${sessionWatered[waterKey] ? 'disabled' : ''}
                          aria-label="Arroser la plante">
                      üíß
                  </button>
                  <button class="water-btn ${sessionWatered[sunKey] ? 'used' : ''}" 
                          onclick="waterPlant('${p.firebaseId}', 'sun')"
                          ${sessionWatered[sunKey] ? 'disabled' : ''}
                          aria-label="Donner du soleil √† la plante">
                      ‚òÄÔ∏è
                  </button>
              </div>
          </div>
      `;
      
      updatePageNav();
  }

  function updatePageNav() {
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage === data.length - 1;
      pageInfo.textContent = `${currentPage + 1} / ${data.length}`;
  }

  window.prevPage = function() {
      if (currentPage > 0) {
          currentPage--;
          renderNotebook();
      }
  }

  window.nextPage = function() {
      if (currentPage < data.length - 1) {
          currentPage++;
          renderNotebook();
      }
  }
</script>

</body>
</html>

