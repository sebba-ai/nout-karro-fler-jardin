<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Despire</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè¥‚Äç‚ò†Ô∏è</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ----------------- AMBIANCE G√âN√âRALE ----------------- */
body 
{
    margin: 0;
    font-family: "Georgia", serif;
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #2f3e34;
    overflow-x: hidden;
}

h1,h2,h3 {
    font-weight: normal;
}

/* ----------------- LOGIN ----------------- */
#login {
    position: fixed;
    inset: 0;
    background: rgba(245,245,240,0.98);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    transition: opacity 3s cubic-bezier(0.4, 0, 0.2, 1); 
}

#login.fade-out {
    opacity: 0;
    pointer-events: none;
}

#loginBox {
    background: rgba(255,255,255,0.85);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

#loginBox input {
    padding: 14px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid #aaa;
    font-size: 16px;
}

#loginBox button {
    margin-top: 20px;
    padding: 14px 30px;
    border: none;
    border-radius: 30px;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* ----------------- THERMOM√àTRE D'√âNERGIE AM√âLIOR√â ----------------- */
#thermo-container {
    position: absolute;
    left: 20px;
    top: 20px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 1.5s ease-in;
}

#thermo-container.visible {
    opacity: 1;
    visibility: visible;
}

#thermo-cadre {
    width: 18px;
    height: 160px;
    background: linear-gradient(to right, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.6) 50%, 
        rgba(255,255,255,0.4) 100%
    );
    backdrop-filter: blur(8px);
    border: 2px solid rgba(47,62,52,0.3);
    border-radius: 12px 12px 0 0;
    position: relative;
    overflow: hidden;
    box-shadow: 
        inset -2px 0 4px rgba(0,0,0,0.1),
        inset 2px 0 4px rgba(255,255,255,0.3);
    border-bottom: none;
}

#thermo-cadre::before {
    content: '';
    position: absolute;
    top: 0;
    left: 1px;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom,
        rgba(255,255,255,0.7) 0%,
        rgba(255,255,255,0.3) 50%,
        rgba(255,255,255,0.1) 100%
    );
    border-radius: 2px;
    z-index: 2;
}

#thermo-reservoir {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e6230e, #f39c12);
    border: 2px solid rgba(47,62,52,0.3);
    margin-top: -6px;
    box-shadow: 
        inset -2px 0 4px rgba(0,0,0,0.1),
        inset 2px 0 4px rgba(255,255,255,0.3);
     position: relative;   
}

#thermo-reservoir::before {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    width: 10px;
    height: 10px;
    background: radial-gradient(circle, 
        rgba(255,255,255,0.6) 0%, 
        transparent 70%
    );
    border-radius: 50%;
}

#thermo-niveau {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 0%;
    background: linear-gradient(to top,
        #e6230e 0%,
        #f39c12 50%,
        #2ecc71 100%
    );
    transition: height 3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: visible;
}

.wave {
    position: absolute;
    top: -8px;
    left: -100%;
    width: 300%;
    height: 16px;
    background: radial-gradient(ellipse at center, 
        rgba(255,255,255,0.4) 0%, 
        transparent 70%
    );
    border-radius: 50%;
    animation: wave-motion 3s ease-in-out infinite;
}

@keyframes wave-motion {
    0%, 100% {
        transform: translateX(0) translateY(0);
    }
    25% {
        transform: translateX(10%) translateY(-2px);
    }
    50% {
        transform: translateX(0) translateY(0);
    }
    75% {
        transform: translateX(-10%) translateY(-2px);
    }
}

.bubble {
    position: absolute;
    background: rgba(255,255,255,0.6);
    border-radius: 50%;
    animation: bubble-rise linear infinite;
    box-shadow: inset -1px -1px 2px rgba(0,0,0,0.1);
}

.bubble:nth-child(2) {
    width: 3px;
    height: 3px;
    left: 25%;
    animation-duration: 4s;
    animation-delay: 0s;
}

.bubble:nth-child(3) {
    width: 4px;
    height: 4px;
    left: 60%;
    animation-duration: 5s;
    animation-delay: 1.2s;
}

.bubble:nth-child(4) {
    width: 2px;
    height: 2px;
    left: 45%;
    animation-duration: 3.5s;
    animation-delay: 2s;
}

@keyframes bubble-rise {
    0% {
        bottom: 0;
        opacity: 0;
        transform: scale(0.8);
    }
    10% {
        opacity: 1;
    }
    80% {
        opacity: 0.8;
    }
    100% {
        bottom: 100%;
        opacity: 0;
        transform: scale(1.2);
    }
}


#thermo-label {
    font-family: "Georgia", serif;
    font-size: 11px;
    font-weight: bold;
    margin-top: 6px;
    color: white;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: transform 0.3s ease, font-size 0.3s ease;
    cursor: pointer;
}

#thermo-label:hover {
    transform: scale(1.8);
    font-size: 14px;
}

#main {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    min-height: 100vh;
    box-sizing: border-box;
    animation: fadeIn 1.2s ease-out;
    position: relative;
    gap: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInTitle {
    from { 
        opacity: 0; 
        transform: translateY(-20px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeInVaporeux {
    0% { 
        opacity: 0;
        filter: blur(15px);
        transform: scale(0.98);
    }
    100% { 
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
    }
}

.title-quote-container {
    background: radial-gradient(circle, 
        rgba(255,215,130,0.85) 0%, 
        rgba(255,215,130,0.6) 60%,
        rgba(255,215,130,0.3) 100%
    );
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    display: block;
    max-width: 600px;
    box-shadow: 0 0 30px rgba(255,215,130,0.6);
    text-align: center;
    animation: halo-pulse 3s ease-in-out infinite;
}

.title-quote-container h2 {
    margin: 0 0 10px 0;
}

.title-quote-container #quote {
    margin: 0;
}

#main h2 {
    font-size: 1.1rem; 
    line-height: 1.5;
    text-align: center;
    margin: 10px auto 20px auto;
    padding: 20px 20px 20px 70px;
    width: 90%;
    max-width: 600px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    color: #2f3e34;
    opacity: 0;
    animation: fadeInTitle 3.5s ease-out 1.5s forwards;
}
.title-quote-container h2 {
    padding: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
}

#garden {
    position: relative;
    width: 100%;
    max-width: 900px;
    height: 65vh;
    min-height: 400px;
    border: 8px solid #3d2817;
    border-top: 4px solid #5a4230;
    border-radius: 8% 8% 48% 48%;
    overflow: hidden;
    box-shadow: 
        inset 0 3px 15px rgba(255,255,255,0.2),
        inset 0 -40px 80px rgba(0,0,0,0.5),
        inset -15px 0 30px rgba(0,0,0,0.3),
        inset 15px 0 30px rgba(0,0,0,0.3),
        0 15px 40px rgba(0,0,0,0.4);
    background: 
        repeating-linear-gradient(
            88deg,
            transparent 0px,
            rgba(0,0,0,0.08) 1px,
            transparent 2px,
            transparent 50px
        ),
        repeating-linear-gradient(
            92deg,
            transparent 0px,
            rgba(0,0,0,0.05) 1px,
            transparent 2px,
            transparent 70px
        ),
        radial-gradient(ellipse 120% 80% at 50% 100%,
            #6b5539 0%,
            #4a3a28 60%,
            #2a1a0f 100%
        );
    opacity: 0;
    filter: blur(15px);
    animation: fadeInVaporeux 4s ease-out 1s forwards;
}

#garden::before {
    content: '';
    position: absolute;
    top: 0;
    left: 8%;
    right: 8%;
    height: 100%;
    background: linear-gradient(180deg,
        rgba(255,255,255,0.15) 0%,
        transparent 25%,
        transparent 75%,
        rgba(0,0,0,0.2) 100%
    );
    pointer-events: none;
    border-radius: inherit;
}

#garden::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 15%;
    background: 
        radial-gradient(ellipse at 25% 40%, rgba(218,195,160,0.3) 2px, transparent 3px),
        radial-gradient(ellipse at 75% 60%, rgba(235,215,185,0.4) 1.5px, transparent 2px),
        radial-gradient(ellipse at 50% 80%, rgba(225,205,175,0.3) 2px, transparent 3px),
        linear-gradient(to top,
            #a0826d 0%,
            #8b7355 50%,
            transparent 100%
        );
    background-size: 80px 80px, 100px 100px, 60px 60px, 100% 100%;
    border-radius: 0 0 48% 48%;
    pointer-events: none;
    z-index: 5;
    opacity: 0.7;
}

@keyframes sparkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}

#addBtn {
    display: block;
    margin: 20px auto;
    padding: 14px 30px;
    border-radius: 40px;
    border: none;
    background: linear-gradient(135deg, #d4b896, #e8d5b7);
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
    opacity: 0;
    animation: fadeIn 2s ease-in-out 1.5s forwards;
}

#addBtn:hover {
    background: linear-gradient(135deg, #b8956a, #d4b896);
    transform: scale(1.05);
}

#quote {
    text-align: center;
    font-style: italic;
    opacity: 0.8;
    margin-bottom: 30px;
}

#thankYouMsg {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: rgba(139,191,159,0.95);
    color: white;
    padding: 30px 50px;
    border-radius: 20px;
    font-size: 20px;
    text-align: center;
    z-index: 150;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 80%;
}

#thankYouMsg.show {
    transform: translate(-50%, -50%) scale(1);
}

.plant-container {
    position: absolute;
    z-index: 1;
}

.plant {
    animation: breathe 10s ease-in-out infinite;
    cursor: pointer;
    transition: filter 0.3s ease;
    position: relative;
    transform-origin: bottom center;
}

.plant:hover {
    filter: brightness(1.1) drop-shadow(0 0 15px rgba(139,191,159,0.6));
}

.plant.falling {
    animation: fall 6s cubic-bezier(0.2, 0, 0.3, 1) forwards, breathe 10s ease-in-out infinite 2s;
}

@keyframes fall {
    0% {
        top: -300px;
        opacity: 0;
        transform: scale(1.2);
    }
    10% {
        opacity: 1;
    }
    100% {
        top: var(--final-top);
        transform: scale(1);
    }
}

.halo-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: radial-gradient(circle, 
    rgba(255,215,130,0.8) 0%, 
    rgba(255,215,130,0.5) 40%,
    rgba(255,215,130,0.2) 70%,
    transparent 100%
); 
    animation: halo-pulse 3s ease-in-out infinite;
    pointer-events: none;
    filter: blur(4px);
}

@keyframes halo-pulse {
    0%, 100% {
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1);
    }
    50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.15);
    }
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
        opacity: 1;
    }
    50% { 
        transform: scale(1.15);
        opacity: 0.7;
    }
}

@keyframes breathe {
    0%,100% { transform: scale(var(--scale, 1)); }
    50% { transform: scale(calc(var(--scale, 1) * 1.3)); }
}

#overlay {
    position: fixed;
    inset: 0;
    background: rgba(250,250,245,0.96);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 90;
}

form {
    background: white;
    padding: 40px;
    border-radius: 25px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}

form select, form textarea, form input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 12px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

form button {
    margin-top: 20px;
    padding: 14px;
    width: 100%;
    border-radius: 30px;
    border: none;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

form button:hover {
    background: #5d8c73;
}

#closeOverlay {
    position: absolute;
    top: 12px;
    right: 12px;
    width: auto;
    margin: 0;
    padding: 0;
    background: none;
    font-size: 28px;
    color: #333;
}

.preview-section {
    background: rgba(111,165,140,0.1);
    padding: 20px;
    border-radius: 15px;
    margin: 15px 0;
    border-left: 4px solid #6fa58c;
}

.preview-section h4 {
    color: #6fa58c;
    margin-top: 0;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.preview-section p {
    margin: 8px 0;
    line-height: 1.6;
    font-size: 14px;
}

.preview-section ul {
    margin: 8px 0;
    padding-left: 20px;
}

.preview-section li {
    margin: 5px 0;
    line-height: 1.5;
}

#categoryPreview {
    display: none;
}

#itemsForm {
    display: none;
}

.form-step {
    animation: fadeIn 0.5s ease-out;
}

.info-box {
    background: rgba(255,215,130,0.2);
    padding: 12px;
    border-radius: 10px;
    font-size: 13px;
    margin: 10px 0;
    color: #6b5d4f;
}


.multi-select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: rgba(255,255,255,0.85);
    font-size: 14px;
    color: #333;
    cursor: pointer;
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    height: 160px;
    transition: border-color 0.3s;
    padding-right: 32px;
}

.multi-select:focus {
    border-color: #6fa58c;
    box-shadow: 0 0 0 3px rgba(111,165,140,0.15);
}

.multi-select option {
    padding: 8px;
}

.multi-select optgroup {
    font-weight: bold;
    color: #6fa58c;
}

.chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    min-height: 18px;
}

.chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: rgba(111,165,140,0.2);
    border: 1px solid #6fa58c;
    border-radius: 20px;
    font-size: 13px;
    color: #4a7a63;
}

.chip .chip-remove {
    cursor: pointer;
    font-size: 15px;
    line-height: 1;
    color: #6fa58c;
    font-weight: bold;
}

#notebook {
    position: fixed;
    right: -100%;
    top: 0;
    bottom: 0;
    width: 100%;
    max-width: 550px;
    background: linear-gradient(to right, #8b7355 0%, #8b7355 20px, #f4e8d0 20px);
    box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    z-index: 150;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

#notebook::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 25px;
    background: linear-gradient(to right, 
        transparent 0%, 
        #f4e8d0 40%
    );
    box-shadow: 
        inset 3px 0 5px rgba(139,115,85,0.3),
        inset -2px 3px 3px rgba(0,0,0,0.1),
        inset -1px -3px 3px rgba(0,0,0,0.1);
    pointer-events: none;
    z-index: 1;
}

#notebook.open {
    right: 0;
}


#notebookContent {
    margin-left: 30px;
    padding: 40px 30px 100px 20px;
    height: 100%;
    overflow-y: auto;
    background: 
        repeating-linear-gradient(
            transparent,
            transparent 31px,
            #e8dcc8 31px,
            #e8dcc8 32px
        ),
        #f4e8d0;
    box-sizing: border-box;
    font-family: 'Caveat', cursive;
    font-size: 24px;
}

.notebook-icon {
    width: 80px;
    height: 80px;
    object-fit: contain;
    margin: 0 auto 15px;
    display: block;
}

.page-date {
    font-size: 20px;
    font-weight: bold;
}

#closeNotebook {
    position: absolute;
    right: 20px;
    top: 20px;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6fa58c;
    z-index: 1;
    transition: transform 0.2s;
}

#closeNotebook:hover {
    transform: rotate(90deg);
}

.notebook-page {
    margin-bottom: 60px;
    padding-bottom: 30px;
    line-height: 32px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 3px solid #6fa58c;
}

.page-date {
    font-size: 14px;
    color: #8b7355;
    font-style: italic;
}

.page-number {
    background: #6fa58c;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
}

.notebook-section {
    margin: 20px 0;
}

.section-label {
    font-weight: bold;
    color: #6fa58c;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.section-content {
    color: #2f3e34;
    font-size: 15px;
    padding-left: 10px;
}

.interaction-stats {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: rgba(139,191,159,0.1);
    border-radius: 8px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

.water-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: rgba(139,191,159,0.15);
    border-radius: 12px;
    justify-content: center;
}

.water-btn {
    background: transparent;
    border: none;
    padding: 12px 20px;
    border-radius: 30px;
    cursor: pointer;
    font-size: 32px;
    transition: all 0.3s;
}

.water-btn:hover:not(:disabled) {
    background: #6fa58c;
    transform: scale(1.1);
}

.water-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    border-color: #ccc;
}

.water-btn.used {
    background: #d0e8d0;
    border-color: #8bbf9f;
}

#pageNav {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px 20px;
    border-radius: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

#pageNav button {
    background: #6fa58c;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
}

#pageNav button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#pageInfo {
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: #6fa58c;
    font-weight: bold;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #6fa58c;
}

@media (max-width: 600px) {
    #main {
        padding: 15px;
    }

    #garden {
        height: 70vh;
        min-height: 400px;
    }

    #main h2 {
        font-size: 0.95rem;
        padding: 18px 18px 18px 65px;
    }

    #addBtn {
        padding: 12px 24px;
        font-size: 16px;
    }

    #thermo-container {
        left: 12px;
        top: 18px;
        transform: scale(0.9);
    }

    form {
        width: 95%;
        padding: 30px 20px;
    }
}

@media (max-height: 500px) {
    #garden {
        height: 300px;
    }
}
</style>

</head>

<body>

<div id="login">
    <div id="loginBox">
        <h2>üå± Le Facteur Humain</h2>
        <p>Rejoins le bivouac des pirates üè¥‚Äç‚ò†Ô∏è</p>
        <input id="pwd" type="password" placeholder="mot de passe">
        <button id="loginBtn">Entrer</button>
    </div>
</div>

<div id="main">
    <div id="thermo-container">
        <div id="thermo-cadre">
            <div id="thermo-niveau">
                <div class="wave"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
            </div>
        </div>
        <div id="thermo-reservoir"></div>
        <div id="thermo-label">üìû2512/‚òé881</div>
    </div>

    <div class="title-quote-container" onclick="document.getElementById('infoPopup').style.display='flex'" style="cursor:pointer;">
      <h2 id="random-title"></h2>
      <div id="quote"></div>
  </div>   

  <button id="addBtn">‚¨áÔ∏è Zarlorüí∞</button>

    <div id="garden">
        <div class="loading">üå± Chargement de la zar l'or...</div>
    </div>
</div>

<div id="thankYouMsg"></div>

<div id="overlay">
    <form id="form">
        <button type="button" id="closeOverlay" style="position:absolute; top:12px; right:12px; background:none; border:none; font-size:28px; color:#333; cursor:pointer; z-index:10;">√ó</button>
        <div id="categorySelection" class="form-step">
            <h3>üåø Planter une exp√©rience</h3>

            <label style="font-weight: bold; margin-top: 15px; display: block;">Choisir une cat√©gorie :</label>
            <select id="categorySelect">
                <option value="">-- S√©lectionner --</option>
                <option value="aide">ü§ù Aide & soutien</option>
                <option value="apprentissage">üß† Apprentissage</option>
                <option value="amelioration">üîß Am√©lioration concr√®te</option>
                <option value="effort">üéØ Effort invisible</option>
                <option value="initiative">üå± Initiative</option>
                <option value="collectif">üë• R√©ussite collective</option>
                <option value="sens">üß≠ Sens & valeurs</option>
            </select>
        </div>

        <div id="categoryPreview" class="form-step">
            <div id="previewContent"></div>
            <button type="button" id="validateBtn">‚úì Cela me convient, continuer</button>
            <button type="button" id="backBtn1" style="background: #999; margin-top: 10px;">‚Üê Retour aux cat√©gories</button>
        </div>

        <div id="itemsForm" class="form-step">
            <h3 id="itemsFormTitle"></h3>
            <div id="itemsFormContent"></div>
            
            <div class="info-box">
                üìå <strong>Forces & valeurs :</strong> optionnelles, pas obligatoires. Vous pouvez en choisir jusqu'√† 3 de chaque.
            </div>

            <label style="font-weight: bold; margin-top: 20px; display: block;">Forces mobilis√©es (max 3) <span onclick="document.getElementById('forcesInfo').style.display='flex'" style="cursor:pointer; color:#6fa58c; font-size:14px;">‚ìò</span></label>
            <select id="forcesSelect" multiple class="multi-select"size="5"></select>
            <div id="forcesChips" class="chips-container"></div>

            <label style="font-weight: bold; margin-top: 20px; display: block;">Valeurs en jeu (max 3) <span onclick="document.getElementById('valeursInfo').style.display='flex'" style="cursor:pointer; color:#6fa58c; font-size:14px;">‚ìò</span></label>
            <select id="valeursSelect" multiple class="multi-select"size="5"></select>
            <div id="valeursChips" class="chips-container"></div>

            <button type="submit">üå∏ Planter</button>
            <button type="button" id="backBtn2" style="background: #999; margin-top: 10px;">‚Üê Changer de cat√©gorie</button>
        </div>
    </form>
</div>

<div id="notebook">
    <button id="closeNotebook">‚úï</button>
    <div id="notebookContent"></div>
    <div id="pageNav">
        <button id="prevBtn">‚Üê Pr√©c√©dent</button>
        <div id="pageInfo"></div>
        <button id="nextBtn">Suivant ‚Üí</button>
    </div>
</div>

<!-- Firebase compat SDK ‚Äî fonctionne partout sans module/import -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyADBlPY8lK_52mFTWWHdoEBcPXa4Dk3FVA",
    authDomain: "jardin-3f127.firebaseapp.com",
    databaseURL: "https://jardin-3f127-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jardin-3f127",
    storageBucket: "jardin-3f127.firebasestorage.app",
    messagingSenderId: "371927426307",
    appId: "1:371927426307:web:dba165b1aaf4b8179e3536"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const plantsRef = database.ref('plants');

  const PASSWORD = "jardin";
  const NIVEAU_ENERGIE = 75;

  const titles = [
  "Qui commande sans ou√Ør l‚Äô√©quipage, m√®ne droit au naufrage.",
  "Capitaine sourd, navire perdu",
  "Le pouvoir qui n‚Äô√©coute point alourdit la coque.",
  "Nul ne rame vaillant s‚Äôil y est men√© √† coups.",
  "Mieux vaut un homme qui choisit la rame que dix forc√©s.",
  "La peur fait avancer d‚Äôun bord, la volont√© m√®ne jusqu‚Äôau port.",
  "Celui qui sait la mer m√®ne la barre, non celui qui crie le plus fort.",
  "Le bon chef montre la voie, le mauvais montre le fouet.",
  "La voix forte ne vaut point la main s√ªre.",
  "Ce qui n‚Äôest point dit pourrit entre les planches.",
  "Les non-dits font mutinerie.",
  "R√®gles claires tiennent l‚Äô√©quipage droit.",
  "Mieux vaut pavillon connu que sabre tir√©.",
  "Le renom gagne des prises que l‚Äôacier perd.",
  "Un nom craint √©vite bien des combats.",
  "Nul ne survit seul en mer longue.",
  "Fr√®res de bord vivent, loups solitaires coulent.",
  "Qui abandonne les siens sera bient√¥t abandonn√©.",
  "Si nou s√®m brinzell nou sa pa k√©yir babafig /si nou plant' banann' nou sa pa manz' kaviar ! Al√© tir in feuye / r√©colt leu tempo !",
];

  const quotes = [
      "Ce √† quoi tu pr√™tes attention grandit.",
      "Chaque geste nourrit une racine invisible.",
      "Le vivant se cultive par la pr√©sence.",
      "Un jardin est une m√©moire qui respire.",
      "Voir, c‚Äôest laisser le monde entrer.",
      "Dans les d√©tails ordinaires dorment les grandes d√©couvertes.",
      "Ce que l‚Äôon regarde avec soin s‚Äôenracine en nous.",
      "La gratitude est une main tendue vers la joie.",
      "Quand le temps s‚Äôefface, l‚Äô√¢me travaille.",
      "L√† o√π l‚Äôattention se dissout, na√Æt la justesse.",
      "Nos forces sont des braises : il suffit d‚Äôen souffler une.",
      "Ce que tu fais avec aisance √©claire ce que tu deviens.",
      "Un sourire sinc√®re agrandit l‚Äôhorizon.",
      "Les liens vrais portent plus loin que les victoires seules.",
      "Le sens n‚Äôest pas trouv√©, il est choisi.",
      "Quand le c≈ìur a un nord, les pas savent o√π aller.",
  ];

  const thankYouMessages = [
      "üå± Une nouvelle graine prend racine dans notre jardin collectif !",
      "‚ú® Merci pour cette belle contribution, elle fera grandir notre √©cosyst√®me !",
      "üå∏ Quelle fiert√© de voir le jardin s'√©panouir gr√¢ce √† toi !",
      "üåø Ta plantation enrichit la biodiversit√© de notre espace partag√© !",
      "üå≥ Chaque exp√©rience plant√©e nourrit la for√™t de nos apprentissages !",
      "üíö Gratitude pour ce don √† la terre commune, il portera ses fruits !",
      "üåæ Ta contribution s'enracine et inspirera d'autres jardiniers !",
      "ü™¥ Merci de cultiver avec nous cet espace de croissance mutuelle !",
      "üå∫ Belle plantation ! Le jardin te remercie de ta pr√©sence attentive !",
      "üçÉ Chaque plante ajout√©e tisse un peu plus notre √©cosyst√®me vivant !"
  ];

  const objets = [];
for (var i = 1; i <= 41; i++) {
    objets.push("assets/objets/objet" + i + ".png");
}
 
  const backgrounds = ["assets/bg-paper.jpg", "assets/bg1.jpg", "assets/bg2.jpg", "assets/bg3.jpg", "assets/bg4.jpg"];

  const categories = {
    aide: {
      emoji: "ü§ù", nom: "Aide & soutien",
      question: "Qu'est-ce qui a facilit√© le travail ou le v√©cu de quelqu'un ?",
      exemple: "¬´ Cette semaine, Paul a pris 20 minutes pour m'expliquer une proc√©dure que je ne comprenais pas. J'ai pu avancer sans stress et √©viter une erreur. ¬ª",
      mecanismes: ["Reconnaissance du prosocial", "Renforcement du sentiment d'appartenance", "Diminution du stress per√ßu"],
      sources: ["<strong>Adam Grant ‚Äì Give and Take</strong><br>‚Üí Voir l'impact concret de son aide augmente la motivation et l'engagement.", "<strong>Baumeister & Leary</strong><br>‚Üí Le besoin d'appartenance est un besoin psychologique fondamental.", "<strong>Thompson & Bolino (2018)</strong><br>‚Üí La reconnaissance de l'aide renforce la coop√©ration future."],
      impact: "plus d'entraide spontan√©e, moins d'isolement.",
      items: [
        { label: "Qu'a fait la personne ?", placeholder: "Fait concret, observable", type: "textarea", name: "item1", required: true },
        { label: "En quoi cela a aid√© ?", placeholder: "Impact imm√©diat", type: "textarea", name: "item2", required: true },
        { label: "(optionnel) Pour qui cela a compt√© ?", placeholder: "Personne ou groupe concern√©", type: "input", name: "item3", required: false }
      ]
    },
    apprentissage: {
      emoji: "üß†", nom: "Apprentissage",
      question: "Qu'avons-nous compris de mieux ?",
      exemple: "¬´ J'ai compris que lorsque je pr√©pare mes r√©ponses √† l'avance, l'√©change devient rigide. En laissant plus de place √† l'√©coute, la discussion est plus fluide. ¬ª",
      mecanismes: ["Transformation de l'erreur en ressource", "D√©veloppement du sentiment de comp√©tence", "Mentalit√© de croissance"],
      sources: ["<strong>Carol Dweck ‚Äì Growth Mindset</strong><br>‚Üí Apprendre = moteur de motivation durable.", "<strong>Kolb ‚Äì Apprentissage exp√©rientiel</strong><br>‚Üí Le sens √©merge de l'exp√©rience r√©fl√©chie.", "<strong>Edmondson</strong><br>‚Üí Les √©quipes apprenantes performent mieux √† long terme."],
      impact: "moins de peur de se tromper, plus d'adaptation.",
      items: [
        { label: "Situation / exp√©rience", placeholder: "D√©cris le contexte...", type: "textarea", name: "item1", required: true },
        { label: "Ce que j'ai compris ou appris", placeholder: "Ta d√©couverte...", type: "textarea", name: "item2", required: true },
        { label: "Ce que je ferai diff√©remment", placeholder: "Action future...", type: "textarea", name: "item3", required: true }
      ]
    },
    amelioration: {
      emoji: "üîß", nom: "Am√©lioration concr√®te",
      question: "Qu'est-ce qui fonctionne mieux qu'avant ?",
      exemple: "¬´ Avant, on passait 15 minutes √† chercher l'info. Maintenant, elle est centralis√©e, on gagne du temps chaque jour. ¬ª",
      mecanismes: ["Sentiment d'efficacit√© collective", "Perception de progr√®s (m√™me petit)"],
      sources: ["<strong>Teresa Amabile ‚Äì Progress Principle</strong><br>‚Üí Le sentiment de progr√®s est le plus puissant moteur de motivation au travail.", "<strong>Lean / Kaizen</strong><br>‚Üí Les petites am√©liorations r√©p√©t√©es ont un impact cumulatif majeur."],
      impact: "redonne prise sur le r√©el, combat l'impuissance.",
      items: [
        { label: "Avant / apr√®s", placeholder: "Tr√®s court, l'essentiel...", type: "textarea", name: "item1", required: true },
        { label: "Ce qui a chang√©", placeholder: "La modification apport√©e...", type: "textarea", name: "item2", required: true },
        { label: "B√©n√©fice principal", placeholder: "Impact positif...", type: "textarea", name: "item3", required: true }
      ]
    },
    effort: {
      emoji: "üéØ", nom: "Effort invisible",
      question: "Qu'est-ce qui a √©t√© tenu malgr√© la difficult√© ?",
      exemple: "¬´ Malgr√© une semaine √©motionnellement lourde, j'ai maintenu la qualit√© de l'accueil des usagers. ¬ª",
      mecanismes: ["Reconnaissance de la charge invisible", "Justice symbolique", "Pr√©vention de l'√©puisement"],
      sources: ["<strong>Axel Honneth ‚Äì Th√©orie de la reconnaissance</strong><br>‚Üí Le manque de reconnaissance est une source majeure de souffrance au travail.", "<strong>Siegrist ‚Äì Effort / R√©compense</strong><br>‚Üí Le d√©s√©quilibre effort-reconnaissance g√©n√®re stress et burnout."],
      impact: "r√©paration morale, baisse du ressentiment.",
      items: [
        { label: "Ce qui √©tait difficile", placeholder: "La difficult√© rencontr√©e...", type: "textarea", name: "item1", required: true },
        { label: "Ce qui a √©t√© maintenu / assur√©", placeholder: "Malgr√© tout, tu as tenu...", type: "textarea", name: "item2", required: true },
        { label: "Pourquoi c'√©tait important", placeholder: "Le sens de cet effort...", type: "textarea", name: "item3", required: true }
      ]
    },
    initiative: {
      emoji: "üå±", nom: "Initiative",
      question: "Qu'est-ce qui a √©t√© tent√© ?",
      exemple: "¬´ J'ai propos√© un nouvel outil, m√™me si tout n'est pas encore en place, √ßa a ouvert la discussion. ¬ª",
      mecanismes: ["Autonomie", "Droit √† l'essai", "Innovation psychologiquement s√ªre"],
      sources: ["<strong>Deci & Ryan ‚Äì Autod√©termination</strong><br>‚Üí L'autonomie est un pilier de la motivation intrins√®que.", "<strong>Edmondson</strong><br>‚Üí Sans droit √† l'initiative, pas d'innovation durable."],
      impact: "plus d'id√©es, moins de conformisme passif.",
      items: [
        { label: "L'id√©e ou l'initiative", placeholder: "Ce que tu as propos√©/tent√©...", type: "textarea", name: "item1", required: true },
        { label: "Pourquoi elle a √©t√© lanc√©e", placeholder: "La motivation...", type: "textarea", name: "item2", required: true },
        { label: "Ce que cela a permis (m√™me partiellement)", placeholder: "R√©sultat, m√™me partiel...", type: "textarea", name: "item3", required: true }
      ]
    },
    collectif: {
      emoji: "üë•", nom: "R√©ussite collective",
      question: "Quand avons-nous mieux fonctionn√© ensemble ?",
      exemple: "¬´ Lors de ce projet, les informations ont bien circul√© et les d√©cisions ont √©t√© prises ensemble. ¬ª",
      mecanismes: ["Identit√© collective", "Coh√©sion", "Intelligence collective"],
      sources: ["<strong>Weick ‚Äì Sensemaking</strong><br>‚Üí Le sens est co-construit dans l'action collective.", "<strong>Hackman</strong><br>‚Üí Les √©quipes efficaces se d√©finissent par leurs processus, pas seulement leurs r√©sultats."],
      impact: "moins de silos, plus de coop√©ration.",
      items: [
        { label: "Moment / contexte", placeholder: "Quand ? Dans quel cadre ?", type: "textarea", name: "item1", required: true },
        { label: "Ce qui a bien circul√©", placeholder: "Info, d√©cision, entraide...", type: "textarea", name: "item2", required: true },
        { label: "Effet sur le travail ou le climat", placeholder: "Impact ressenti...", type: "textarea", name: "item3", required: true }
      ]
    },
    sens: {
      emoji: "üß≠", nom: "Sens & valeurs",
      question: "Quand avons-nous agi de fa√ßon align√©e ?",
      exemple: "¬´ Nous avons pris plus de temps pour respecter la situation de la personne, m√™me si c'√©tait plus lent. ¬ª",
      mecanismes: ["Alignement valeurs‚Äìactions", "Motivation morale", "Pr√©vention du cynisme"],
      sources: ["<strong>Viktor Frankl</strong><br>‚Üí Le sens prot√®ge face √† l'adversit√©.", "<strong>Rosso, Dekas & Wrzesniewski (2010)</strong><br>‚Üí Le sens au travail augmente engagement et r√©silience."],
      impact: "r√©sistance √† l'usure et √† la perte de sens.",
      items: [
        { label: "Situation", placeholder: "Le contexte...", type: "textarea", name: "item1", required: true },
        { label: "Valeur ou principe respect√©", placeholder: "Ce qui a √©t√© honor√©...", type: "textarea", name: "item2", required: true },
        { label: "Pourquoi c'√©tait important", placeholder: "Le sens profond...", type: "textarea", name: "item3", required: true }
      ]
    }
  };

  const forcesVIA = [
    { group: "üß† SAGESSE ET CONNAISSANCE", items: ["Curiosit√©", "Amour de l'apprentissage", "Jugement / Pens√©e critique", "Ing√©niosit√© / Cr√©ativit√©", "Perspective / Sagesse"] },
    { group: "üí™ COURAGE", items: ["Bravoure", "Pers√©v√©rance", "Int√©grit√© / Honn√™tet√©", "Enthousiasme"] },
    { group: "‚ù§Ô∏è HUMANIT√â", items: ["Amour", "Gentillesse", "Intelligence sociale / Empathie"] },
    { group: "‚öñÔ∏è JUSTICE", items: ["√âquit√©", "Leadership", "Travail d'√©quipe / Esprit de citoyennet√©"] },
    { group: "üßò TEMP√âRANCE", items: ["Pardon / Indulgence", "Humilit√© / Modestie", "Prudence / Pr√©venance", "Autocontr√¥le / R√©gulation de soi"] },
    { group: "‚ú® TRANSCENDANCE", items: ["Appr√©ciation de la beaut√© et de l'excellence", "Gratitude", "Espoir / Optimisme", "Humour", "Spiritualit√© / Foi"] }
  ];

  const valeursSchwartz = [
    { group: "üåç OUVERTURE AU CHANGEMENT", items: ["Autod√©termination-pens√©e", "Autod√©termination-action", "Stimulation", "H√©donisme"] },
    { group: "üéØ CROISSANCE PERSONNELLE", items: ["R√©alisation", "Pouvoir-dominance", "Pouvoir-ressources"] },
    { group: "üõ°Ô∏è CONSERVATION", items: ["Image publique", "S√©curit√©-personnel", "Tradition", "Conformit√©-r√®gles", "Conformit√©-interpersonnelle", "Humilit√©"] },
    { group: "üíó D√âPASSEMENT DE SOI", items: ["Bienveillance-soins", "Bienveillance-fiabilit√©", "Universalisme-pr√©occupation", "Universalisme-nature", "Universalisme-tol√©rance"] }
  ];

  let data = [];
  let currentPage = 0;
  let sessionWatered = {};
  let selectedCategory = null;
  let selectedForces = [];
  let selectedValeurs = [];

  const overlay = document.getElementById('overlay');
  const form = document.getElementById('form');
  const garden = document.getElementById('garden');
  const notebook = document.getElementById('notebook');
  const notebookContent = document.getElementById('notebookContent');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');

  function setRandomBackground() {
    const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = 'url("' + randomBg + '")';
  }

  function setRandomTitle() {
    const titleEl = document.getElementById('random-title');
    if (!titleEl) return;

    const randomIndex = Math.floor(Math.random() * titles.length);
    titleEl.innerText = titles[randomIndex];
}

  function showThankYouMessage() {
    const msg = thankYouMessages[Math.floor(Math.random() * thankYouMessages.length)];
    const msgEl = document.getElementById('thankYouMsg');
    msgEl.textContent = msg;
    msgEl.classList.add('show');
    setTimeout(function() { msgEl.classList.remove('show'); }, 4000);
  }

  // ===== FIX MOT DE PASSE =====
  // .trim() √©limine les espaces/caract√®res invisibles avant et apr√®s la saisie
  // .toLowerCase() permet d'accepter peu importe la casse (Jardin, JARDIN, jardin‚Ä¶)
  function checkPassword() {
    const pwd = document.getElementById('pwd');
    const login = document.getElementById('login');
    const main = document.getElementById('main');
    const thermo = document.getElementById('thermo-container');
    const niveau = document.getElementById('thermo-niveau');
    const quote = document.getElementById('quote');

    const saisi = pwd.value.trim().toLowerCase();

    if (saisi === PASSWORD) {
        setRandomBackground();
        loadPlants();
        quote.innerText = quotes[Math.floor(Math.random()*quotes.length)];
        setRandomTitle();
        main.style.display = "flex";
        setTimeout(function() { thermo.classList.add('visible'); }, 1000);
        setTimeout(function() { niveau.style.height = NIVEAU_ENERGIE + "%"; }, 1500);
        login.classList.add('fade-out');
        setTimeout(function() { login.style.display = "none"; }, 3000);
    } else {
        alert("Mot de passe incorrect");
    }
  }
  // ===== FIN FIX =====

  document.getElementById('loginBtn').addEventListener('click', checkPassword);
  document.getElementById('pwd').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') checkPassword();
  });

  document.getElementById('addBtn').addEventListener('click', function() {
      document.getElementById('thermo-container').style.opacity = '0';
      document.getElementById('thermo-container').style.visibility = 'hidden';
      document.getElementById('categorySelection').style.display = 'block';
      document.getElementById('categoryPreview').style.display = 'none';
      document.getElementById('itemsForm').style.display = 'none';
      document.getElementById('categorySelect').value = '';
      selectedCategory = null;
      selectedForces = [];
      selectedValeurs = [];
      overlay.style.display = "flex";
  });

  document.getElementById('categorySelect').addEventListener('change', function() {
    const categoryKey = this.value;
    if (!categoryKey) {
        document.getElementById('categoryPreview').style.display = 'none';
        return;
    }
    selectedCategory = categoryKey;
    const cat = categories[categoryKey];
    const previewHTML = '<h3>' + cat.emoji + ' ' + cat.nom + '</h3>' +
      '<div class="preview-section"><h4>üéØ Question centrale</h4><p>' + cat.question + '</p></div>' +
      '<div class="preview-section"><h4>üé¨ Exemple</h4><p>' + cat.exemple + '</p></div>' +
      '<div class="preview-section"><h4>üß† M√©canismes activ√©s</h4><ul>' + cat.mecanismes.map(function(m) { return '<li>' + m + '</li>'; }).join('') + '</ul></div>' +
      '<div class="preview-section"><h4>üî¨ Sources & id√©es fortes</h4><ul>' + cat.sources.map(function(s) { return '<li>' + s + '</li>'; }).join('') + '</ul></div>' +
      '<div class="preview-section"><h4>üëâ Impact cl√©</h4><p>' + cat.impact + '</p></div>';
    document.getElementById('previewContent').innerHTML = previewHTML;
    document.getElementById('categorySelection').style.display = 'none';
    document.getElementById('categoryPreview').style.display = 'block';
  });

  document.getElementById('validateBtn').addEventListener('click', function() {
    if (!selectedCategory) return;
    const cat = categories[selectedCategory];
    document.getElementById('itemsFormTitle').textContent = cat.emoji + ' ' + cat.nom;
    let itemsHTML = '';
    cat.items.forEach(function(item) {
      if (item.type === 'textarea') {
        itemsHTML += '<label style="font-weight: bold; margin-top: 15px; display: block;">' + item.label + (item.required ? ' *' : '') + '</label>' +
          '<textarea name="' + item.name + '" placeholder="' + item.placeholder + '" ' + (item.required ? 'required' : '') + '></textarea>';
      } else {
        itemsHTML += '<label style="font-weight: bold; margin-top: 15px; display: block;">' + item.label + (item.required ? ' *' : '') + '</label>' +
          '<input name="' + item.name + '" placeholder="' + item.placeholder + '" ' + (item.required ? 'required' : '') + '>';
      }
    });
    document.getElementById('itemsFormContent').innerHTML = itemsHTML;
    createForcesSelector();
    createValeursSelector();
    document.getElementById('categoryPreview').style.display = 'none';
    document.getElementById('itemsForm').style.display = 'block';
  });

  document.getElementById('backBtn1').addEventListener('click', backToCategories);
  document.getElementById('backBtn2').addEventListener('click', backToCategories);

  function backToCategories() {
    document.getElementById('categorySelection').style.display = 'block';
    document.getElementById('categoryPreview').style.display = 'none';
    document.getElementById('itemsForm').style.display = 'none';
    selectedCategory = null;
    selectedForces = [];
    selectedValeurs = [];
    document.getElementById('forcesChips').innerHTML = '';
    document.getElementById('valeursChips').innerHTML = '';
  }

  function createForcesSelector() {
    const select = document.getElementById('forcesSelect');
    select.innerHTML = '';
    select.appendChild(createEmptyOption('‚Äî Choisir une force ‚Äî'));
    forcesVIA.forEach(function(group) {
      const optgroup = document.createElement('optgroup');
      optgroup.label = group.group;
      group.items.forEach(function(force) {
        const opt = document.createElement('option');
        opt.value = force;
        opt.textContent = force;
        optgroup.appendChild(opt);
      });
      select.appendChild(optgroup);
    });
    select.addEventListener('change', function() {
      const chosen = this.value;
      if (!chosen) return;
      this.value = '';
      if (selectedForces.indexOf(chosen) === -1) {
        if (selectedForces.length < 3) {
          selectedForces.push(chosen);
          renderChips('forcesChips', selectedForces, 'forces');
        }
      }
    });
  }

  function createValeursSelector() {
    const select = document.getElementById('valeursSelect');
    select.innerHTML = '';
    select.appendChild(createEmptyOption('‚Äî Choisir une valeur ‚Äî'));
    valeursSchwartz.forEach(function(group) {
      const optgroup = document.createElement('optgroup');
      optgroup.label = group.group;
      group.items.forEach(function(valeur) {
        const opt = document.createElement('option');
        opt.value = valeur;
        opt.textContent = valeur;
        optgroup.appendChild(opt);
      });
      select.appendChild(optgroup);
    });
    select.addEventListener('change', function() {
      const chosen = this.value;
      if (!chosen) return;
      this.value = '';
      if (selectedValeurs.indexOf(chosen) === -1) {
        if (selectedValeurs.length < 3) {
          selectedValeurs.push(chosen);
          renderChips('valeursChips', selectedValeurs, 'valeurs');
        }
      }
    });
  }

  function createEmptyOption(text) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = text;
    return opt;
  }

  function renderChips(containerId, items, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    items.forEach(function(item, index) {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.innerHTML = item + ' <span class="chip-remove" onclick="removeChip(\'' + type + '\', ' + index + ')">√ó</span>';
      container.appendChild(chip);
    });
  }

  function removeChip(type, index) {
    if (type === 'forces') {
      selectedForces.splice(index, 1);
      renderChips('forcesChips', selectedForces, 'forces');
    } else {
      selectedValeurs.splice(index, 1);
      renderChips('valeursChips', selectedValeurs, 'valeurs');
    }
  }

  window.removeChip = removeChip;

  function loadPlants() {
    plantsRef.on('value', function(snapshot) {
      data = [];
      snapshot.forEach(function(childSnapshot) {
        const plant = childSnapshot.val();
        plant.firebaseId = childSnapshot.key;
        data.push(plant);
      });
      data.sort(function(a, b) { return b.id - a.id; });
      renderGarden();
    });
  }

  function getRandomObjet() {
    return objets[Math.floor(Math.random() * objets.length)];
}

function getRandomSize() {
    return 20 + Math.floor(Math.random() * 40);
}
function getEmpilagePosition() {
    var count = data.filter(function(p) { return !p.type; }).length;
    var row = Math.floor(count / 8);
    var col = count % 6;
    var baseX = 10 + col * 13;
    var baseY = 90 - row * 6;
    var x = baseX + (Math.random() * 1.5 - 0.75);
    var y = baseY + (Math.random() * 1.5 - 0.75);
    return { x: x, y: y };
}

form.addEventListener("submit", function(e) {
    e.preventDefault();
    var f = new FormData(form);
    if (!selectedCategory) {
        alert("Veuillez s√©lectionner une cat√©gorie");
        return;
    }
    var cat = categories[selectedCategory];
    var randomImg = getRandomObjet();
    var size = getRandomSize();
    var position = getEmpilagePosition();
    var items = {};
    cat.items.forEach(function(item) {
        items[item.name] = f.get(item.name) || '';
    });

    const newPlant = {
    id: Date.now(),
    categorie: selectedCategory,
    categorieNom: cat.nom,
    categorieEmoji: cat.emoji,
    items: items,
    forces: selectedForces,
    valeurs: selectedValeurs,
    img: randomImg,
    size: size,
    x: position.x,
    y: position.y,
    bisous: 0,
    merci: 0,
    etoile: 0,
    date: new Date().toLocaleDateString("fr-FR")
};
plantsRef.push(newPlant).then(function() {
    overlay.style.display = "none";
    form.reset();
    backToCategories();
    
    setTimeout(function() {
        showThankYouMessage();
    }, 2500);
});
});
function renderGarden() {
    garden.innerHTML = "";
    var newObjects = data.filter(function(p) { return !p.type; });
    if (newObjects.length === 0) {
        garden.innerHTML = "<div class='loading'>üí∞ Le coffre est vide... Ajoute le premier tr√©sor !</div>";
        return;
    }
    newObjects.forEach(function(p, i) {
        const container = document.createElement("div");
        container.className = "plant-container";
        container.style.left = p.x + "%";
        container.style.setProperty('--final-top', p.y + '%');
        container.style.top = p.y + '%';
        
        const zIndex = (i === 0) ? 100 : Math.round((100 - p.y) / 5);
        container.style.zIndex = zIndex;
        
        const img = document.createElement("img");
        img.src = p.img;
        img.alt = "Objet " + i;
        img.className = "plant";
        img.style.width = (p.size || 200) + "px";
        
        const objIndex = data.indexOf(p);
        img.onclick = function() { openNotebook(objIndex); };
        
        if (i === 0) {
            img.classList.add("falling");
            const halo = document.createElement("div");
            halo.className = "halo-effect";
            halo.style.width = ((p.size || 200) + 80) + "px";
            halo.style.height = ((p.size || 200) + 80) + "px";
            container.appendChild(halo);
        }
        
        container.appendChild(img);
        garden.appendChild(container);
    });
    
    if (document.getElementById('fond-objets')) {
        document.getElementById('fond-objets').remove();
    }
    renderFondObjets();
}
        
        function renderFondObjets() {
            const fond = document.createElement('div');
            fond.id = 'fond-objets';
            fond.style.cssText = 'position:absolute; bottom:0; left:0; right:0; height:35%; z-index:4; pointer-events:none; overflow:hidden;';
            
            for (let i = 0; i < 30; i++) {
                const obj = document.createElement('img');
                obj.src = objets[Math.floor(Math.random() * objets.length)];
                obj.style.cssText = 'position:absolute; width:' + (25 + Math.random() * 35) + 'px; opacity:0.4; bottom:' + (Math.random() * 40 - 10) + '%; left:' + (Math.random() * 95) + '%;';
                fond.appendChild(obj);
            }
            
            document.getElementById('garden').appendChild(fond);
        }

  function openNotebook(index) {
    currentPage = index;
    notebook.classList.remove("open");
    setTimeout(function() {
      renderNotebook();
      notebook.classList.add("open");
    }, 40);
  }

  document.getElementById('closeOverlay').addEventListener('click', function() {
    overlay.style.display = "none";
    document.getElementById('thermo-container').style.opacity = '1';
    document.getElementById('thermo-container').style.visibility = 'visible';
  });
  document.getElementById('closeNotebook').addEventListener('click', function() {
    notebook.classList.remove("open");
  });

  function waterPlant(plantId, type) {
    const sessionKey = plantId + '_' + type;
    if (sessionWatered[sessionKey]) return;
    const plant = data.find(function(p) { return p.firebaseId === plantId; });
    if (!plant) return;
    
    if (type === 'bisous') {
        plant.bisous = (plant.bisous || 0) + 1;
    } else if (type === 'merci') {
        plant.merci = (plant.merci || 0) + 1;
    } else if (type === 'etoile') {
        plant.etoile = (plant.etoile || 0) + 1;
    }
    
    sessionWatered[sessionKey] = true;
    database.ref('plants/' + plantId).update({ 
        bisous: plant.bisous, 
        merci: plant.merci, 
        etoile: plant.etoile 
    });
    renderNotebook();
}

window.waterPlant = waterPlant;

var thermoLabel = document.getElementById('thermo-label');
var isZoomed = false;

thermoLabel.addEventListener('touchstart', function(e) {
    e.preventDefault();
    isZoomed = !isZoomed;
    if (isZoomed) {
        this.style.transform = 'scale(1.8)';
        this.style.fontSize = '14px';
    } else {
        this.style.transform = 'scale(1)';
        this.style.fontSize = '11px';
    }
});

function renderNotebook() {
    if (data.length === 0) {
        notebookContent.innerHTML = "<p style='text-align:center; padding:40px;'>Aucun tr√©sor dans le coffre pour l'instant‚Ä¶</p>";
        return;
    }
    const p = data[currentPage];
    const bisousKey = p.firebaseId + '_bisous';
    const merciKey = p.firebaseId + '_merci';
    const etoileKey = p.firebaseId + '_etoile';
    
    const totalInteractions = (p.bisous || 0) + (p.merci || 0) + (p.etoile || 0);
    const pourcentage = Math.min(100, totalInteractions * 10);
    
    let itemsHTML = '';
    if (p.items) {
        const cat = categories[p.categorie];
        if (cat) {
            cat.items.forEach(function(item) {
                const value = p.items[item.name];
                if (value) {
                    itemsHTML += '<div class="notebook-section"><div class="section-label">' + item.label + '</div><div class="section-content">' + value + '</div></div>';
                }
            });
        }
    }
    
    let forcesHTML = '';
    if (p.forces && p.forces.length > 0) {
        forcesHTML = '<div class="notebook-section"><div class="section-label">üí™ Forces mobilis√©es</div><div class="section-content">' + p.forces.join(', ') + '</div></div>';
    }
    
    let valeursHTML = '';
    if (p.valeurs && p.valeurs.length > 0) {
        valeursHTML = '<div class="notebook-section"><div class="section-label">‚≠ê Valeurs en jeu</div><div class="section-content">' + p.valeurs.join(', ') + '</div></div>';
    }
    
    notebookContent.innerHTML = '<div class="notebook-page"><div class="page-header"><img src="' + p.img + '" class="notebook-icon"><div class="page-date">üìÖ ' + p.date + ' ‚Ä¢ ' + (p.categorieEmoji || '') + ' ' + (p.categorieNom || 'Exp√©rience') + '</div></div>' +
        itemsHTML + forcesHTML + valeursHTML +
        '<div class="interaction-stats" style="text-align:center;"><div class="stat-item">üíã ' + (p.bisous || 0) + '</div><div class="stat-item">üôè ' + (p.merci || 0) + '</div><div class="stat-item">‚ú® ' + (p.etoile || 0) + '</div></div>'+
        '<div class="water-actions"><button class="water-btn ' + (sessionWatered[bisousKey] ? 'used' : '') + '" onclick="waterPlant(\'' + p.firebaseId + '\', \'bisous\')" ' + (sessionWatered[bisousKey] ? 'disabled' : '') + ' aria-label="Envoyer un bisou">üíã</button>' +
        '<button class="water-btn ' + (sessionWatered[merciKey] ? 'used' : '') + '" onclick="waterPlant(\'' + p.firebaseId + '\', \'merci\')" ' + (sessionWatered[merciKey] ? 'disabled' : '') + ' aria-label="Remercier">üôè</button>' +
        '<button class="water-btn ' + (sessionWatered[etoileKey] ? 'used' : '') + '" onclick="waterPlant(\'' + p.firebaseId + '\', \'etoile\')" ' + (sessionWatered[etoileKey] ? 'disabled' : '') + ' aria-label="√âtoile scintillante">‚ú®</button></div></div>';
        notebookContent.innerHTML += '<img src="assets/objets/objet26.png" style="width:100%; margin-top:30px; opacity:0.6;">'; 
    updatePageNav();
}

  function updatePageNav() {
    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage === data.length - 1;
    pageInfo.textContent = (currentPage + 1) + ' / ' + data.length;
  }

  prevBtn.addEventListener('click', function() {
    if (currentPage > 0) {
      currentPage--;
      renderNotebook();
    }
  });

  nextBtn.addEventListener('click', function() {
    if (currentPage < data.length - 1) {
      currentPage++;
      renderNotebook();
    }
  });
</script>
<div id="infoPopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:20px; max-width:500px; position:relative;">
      <button onclick="document.getElementById('infoPopup').style.display='none'" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:28px; cursor:pointer;">√ó</button>
      <h3>Information</h3>
      <p>Mets ton texte ici !</p>
  </div>
</div>
<div id="forcesInfo" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:20px; max-width:500px; position:relative;">
      <button onclick="document.getElementById('forcesInfo').style.display='none'" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:28px; cursor:pointer;">√ó</button>
      <h3>üí™ Forces VIA</h3>
      <p>Les forces de caract√®re sont des qualit√©s positives qui refl√®tent ce qu'il y a de meilleur en nous. Choisis jusqu'√† 3 forces que tu as mobilis√©es dans cette exp√©rience.</p>
  </div>
</div>

<div id="valeursInfo" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:20px; max-width:500px; position:relative;">
      <button onclick="document.getElementById('valeursInfo').style.display='none'" style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:28px; cursor:pointer;">√ó</button>
      <h3>‚≠ê Valeurs de Schwartz</h3>
      <p>Les valeurs repr√©sentent ce qui est important pour toi dans la vie. Identifie jusqu'√† 3 valeurs qui √©taient en jeu dans cette situation.</p>
  </div>
</div>
</body>
</html>
