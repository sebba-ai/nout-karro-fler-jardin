<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Despire</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ----------------- AMBIANCE G√âN√âRALE ----------------- */
body {
    margin: 0;
    font-family: "Georgia", serif;
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #2f3e34;
    overflow-x: hidden;
}

h1,h2,h3 {
    font-weight: normal;
}

/* ----------------- LOGIN ----------------- */
#login {
    position: fixed;
    inset: 0;
    background: rgba(245,245,240,0.96);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

#loginBox {
    background: rgba(255,255,255,0.85);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

#loginBox input {
    padding: 14px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid #aaa;
    font-size: 16px;
}

#loginBox button {
    margin-top: 20px;
    padding: 14px 30px;
    border: none;
    border-radius: 30px;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* ----------------- PAGE PRINCIPALE ----------------- */
#main {
    display: none;
    padding: 40px;
}

#quote {
    text-align: center;
    font-style: italic;
    opacity: 0.8;
    margin-bottom: 30px;
}

/* ----------------- BOUTON AJOUT ----------------- */
#addBtn {
    display: block;
    margin: 30px auto;
    padding: 16px 36px;
    border-radius: 40px;
    border: none;
    background: #8bbf9f;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

/* ----------------- JARDIN ----------------- */
#garden {
    position: relative;
    width: 100%;
    height: 600px;
    border-radius: 30px;
    background: rgba(255,255,255,0.35);
    overflow: hidden;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.08);
}

.plant {
    position: absolute;
    animation: breathe 8s ease-in-out infinite;
    cursor: pointer;
    transition: transform 0.5s ease, filter 0.3s ease;
}

.plant.arbre, .plant.arbuste {
    transform-origin: bottom center;
}

.plant.fleur, .plant.fruit {
    transform-origin: center center;
}

.plant.oiseau, .plant.papillon {
    transform-origin: center center;
}

.plant:hover {
    filter: brightness(1.1) drop-shadow(0 0 15px rgba(139,191,159,0.6));
}

.plant.latest {
    filter: drop-shadow(0 0 20px rgba(255,215,130,0.9));
}

@keyframes breathe {
    0%,100% { transform: scale(var(--scale, 1)); }
    50% { transform: scale(calc(var(--scale, 1) * 1.04)); }
}

/* ----------------- FORMULAIRE AJOUT ----------------- */
#overlay {
    position: fixed;
    inset: 0;
    background: rgba(250,250,245,0.96);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 90;
}

form {
    background: white;
    padding: 40px;
    border-radius: 25px;
    width: 420px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
}

form select, form textarea, form input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 12px;
    border: 1px solid #ccc;
}

form button {
    margin-top: 20px;
    padding: 14px;
    width: 100%;
    border-radius: 30px;
    border: none;
    background: #6fa58c;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

/* ----------------- CARNET DE JARDINIER ----------------- */
#notebook {
    position: fixed;
    right: -600px;
    top: 0;
    bottom: 0;
    width: 550px;
    background: linear-gradient(to right, #8b7355 0%, #8b7355 20px, #f9f7f1 20px);
    box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    z-index: 95;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

#notebook.open {
    right: 0;
}

/* Spirale d√©corative */
#notebook::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 40px;
    bottom: 40px;
    width: 12px;
    background: repeating-linear-gradient(
        to bottom,
        transparent 0px,
        transparent 15px,
        #6b5d4f 15px,
        #6b5d4f 20px,
        transparent 20px,
        transparent 35px
    );
    border-radius: 2px;
}

#notebookContent {
    margin-left: 30px;
    padding: 40px 30px 100px 20px;
    height: 100%;
    overflow-y: auto;
    background: 
        repeating-linear-gradient(
            transparent,
            transparent 31px,
            #e8dcc8 31px,
            #e8dcc8 32px
        ),
        #f9f7f1;
}

#closeNotebook {
    position: absolute;
    right: 20px;
    top: 20px;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6fa58c;
    z-index: 1;
    transition: transform 0.2s;
}

#closeNotebook:hover {
    transform: rotate(90deg);
}

.notebook-page {
    margin-bottom: 60px;
    padding-bottom: 30px;
    border-bottom: 2px dashed #d4c5b0;
    line-height: 32px;
}

.notebook-page:last-child {
    border-bottom: none;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 3px solid #6fa58c;
}

.page-date {
    font-size: 14px;
    color: #8b7355;
    font-style: italic;
}

.page-number {
    background: #6fa58c;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
}

.notebook-section {
    margin: 20px 0;
}

.section-label {
    font-weight: bold;
    color: #6fa58c;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.section-content {
    color: #2f3e34;
    font-size: 15px;
    padding-left: 10px;
}

.interaction-stats {
    display: flex;
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: rgba(139,191,159,0.1);
    border-radius: 8px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}

/* Boutons d'arrosage */
.water-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: rgba(139,191,159,0.15);
    border-radius: 12px;
    justify-content: center;
}

.water-btn {
    background: white;
    border: 2px solid #6fa58c;
    padding: 12px 20px;
    border-radius: 30px;
    cursor: pointer;
    font-size: 32px;
    transition: all 0.3s;
}

.water-btn:hover:not(:disabled) {
    background: #6fa58c;
    transform: scale(1.1);
}

.water-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    border-color: #ccc;
}

.water-btn.used {
    background: #d0e8d0;
    border-color: #8bbf9f;
}

/* Navigation pages */
#pageNav {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px 20px;
    border-radius: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

#pageNav button {
    background: #6fa58c;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
}

#pageNav button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#pageInfo {
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: #6fa58c;
    font-weight: bold;
}

/* Loading indicator */
.loading {
    text-align: center;
    padding: 20px;
    color: #6fa58c;
}
</style>

</head>

<body>

<div id="login">
    <div id="loginBox">
        <h2>üå± Nout KaroOburo</h2>
        <p>Entre dans le jardin</p>
        <input id="pwd" type="password" placeholder="mot de passe">
        <button onclick="checkPassword()">Entrer</button>
    </div>
</div>

<div id="main">
    <h1>Si nous plante carotte nous r√©colt√© carotte, si nou plante banane nous recolt√© banane</h1>
    <div id="quote"></div>

```
<button id="addBtn" onclick="openForm()">‚ûï Planter une exp√©rience</button>

<div id="garden">
    <div class="loading">üå± Chargement du jardin...</div>
</div>
```

</div>

<div id="overlay">
<form id="form">
  <h3>üåø Planter une exp√©rience</h3>

  <select name="activite" required>
    <option value="">Contexte / activit√©</option>
    <option>Soin / accompagnement</option>
    <option>√âchange / relation</option>
    <option>Cr√©ation / r√©flexion</option>
    <option>Transmission</option>
    <option>Autre</option>
  </select>

  <textarea name="experience"
   placeholder="D√©cris l'exp√©rience v√©cue, simplement‚Ä¶"
   required></textarea>

  <textarea name="ressenti"
   placeholder="Ce que cela a provoqu√©, appris, transform√©‚Ä¶"></textarea>

  <select name="force">
    <option value="">Force mobilis√©e (VIA)</option>

```
<optgroup label="üß† SAGESSE ET CONNAISSANCE">
  <option>Curiosit√©</option>
  <option>Amour de l'apprentissage</option>
  <option>Jugement / Pens√©e critique</option>
  <option>Ing√©niosit√© / Cr√©ativit√©</option>
  <option>Perspective / Sagesse</option>
</optgroup>

<optgroup label="üí™ COURAGE">
  <option>Bravoure</option>
  <option>Pers√©v√©rance</option>
  <option>Int√©grit√© / Honn√™tet√©</option>
  <option>Enthousiasme</option>
</optgroup>

<optgroup label="‚ù§Ô∏è HUMANIT√â">
  <option>Amour</option>
  <option>Gentillesse</option>
  <option>Intelligence sociale / Empathie</option>
</optgroup>

<optgroup label="‚öñÔ∏è JUSTICE">
  <option>√âquit√©</option>
  <option>Leadership</option>
  <option>Travail d'√©quipe / Esprit de citoyennet√©</option>
</optgroup>

<optgroup label="üßò TEMP√âRANCE">
  <option>Pardon / Indulgence</option>
  <option>Humilit√© / Modestie</option>
  <option>Prudence / Pr√©venance</option>
</optgroup>

<optgroup label="‚ú® TRANSCENDANCE">
  <option>Appr√©ciation de la beaut√© et de l'excellence</option>
  <option>Gratitude</option>
  <option>Espoir / Optimisme</option>
  <option>Humour</option>
  <option>Spiritualit√© / Foi</option>
</optgroup>
```

  </select>

<input name="forceLibre"
placeholder="Autre force (si diff√©rente)">

  <select name="valeur">
    <option value="">Valeur en jeu (Schwartz)</option>

```
<optgroup label="üåç OUVERTURE AU CHANGEMENT">
  <option>Autod√©termination-pens√©e</option>
  <option>Autod√©termination-action</option>
  <option>Stimulation</option>
  <option>H√©donisme</option>
</optgroup>

<optgroup label="üéØ CROISSANCE PERSONNELLE">
  <option>R√©alisation</option>
  <option>Pouvoir-dominance</option>
  <option>Pouvoir-ressources</option>
</optgroup>

<optgroup label="üõ°Ô∏è CONSERVATION">
  <option>Image publique</option>
  <option>S√©curit√©-personnel</option>
  <option>Tradition</option>
  <option>Conformit√©-r√®gles</option>
  <option>Conformit√©-interpersonnelle</option>
  <option>Humilit√©</option>
</optgroup>

<optgroup label="üíó D√âPASSEMENT DE SOI">
  <option>Bienveillance-soins</option>
  <option>Bienveillance-fiabilit√©</option>
  <option>Universalisme-pr√©occupation</option>
  <option>Universalisme-nature</option>
  <option>Universalisme-tol√©rance</option>
</optgroup>
```

  </select>

<input name="pourQui"
placeholder="Pour qui cette exp√©rience a compt√© ?">

<button type="submit">üå∏ Planter</button>

</form>
</div>

<!-- CARNET DE JARDINIER -->

<div id="notebook">
    <button id="closeNotebook" onclick="closeNotebook()">‚úï</button>
    <div id="notebookContent"></div>
    <div id="pageNav">
        <button onclick="prevPage()" id="prevBtn">‚Üê Pr√©c√©dent</button>
        <div id="pageInfo"></div>
        <button onclick="nextPage()" id="nextBtn">Suivant ‚Üí</button>
    </div>
</div>

<!-- Firebase SDK -->

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyADBlPY8lK_52mFTWWHdoEBcPXa4Dk3FVA",
    authDomain: "jardin-3f127.firebaseapp.com",
    databaseURL: "https://jardin-3f127-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jardin-3f127",
    storageBucket: "jardin-3f127.firebasestorage.app",
    messagingSenderId: "371927426307",
    appId: "1:371927426307:web:dba165b1aaf4b8179e3536"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const plantsRef = ref(database, 'plants');

  window.db = database;
  window.plantsRef = plantsRef;

  const PASSWORD = "jardin";

  const quotes = [
      "Ce √† quoi tu pr√™tes attention grandit.",
      "Chaque geste nourrit une racine invisible.",
      "Le vivant se cultive par la pr√©sence.",
      "Un jardin est une m√©moire qui respire."
  ];

  // üå≥ NOUVELLES LISTES D'IMAGES PAR TYPE
  const plantTypes = {
    arbre: [
      "assets/plants/arbre1.png",
      "assets/plants/arbre2.png",
      "assets/plants/arbre3.png"
    ],
    arbuste: [
      "assets/plants/arbuste1.png",
      "assets/plants/arbuste2.png",
      "assets/plants/arbuste3.png"
    ],
    fleur: [
      "assets/plants/fleur1.png",
      "assets/plants/fleur2.png",
      "assets/plants/fleur3.png",
      "assets/plants/fleur4.png"
    ],
    fruit: [
      "assets/plants/fruit1.png",
      "assets/plants/fruit2.png",
      "assets/plants/fruit3.png"
    ],
    oiseau: [
      "assets/plants/oiseau1.png",
      "assets/plants/oiseau2.png",
      "assets/plants/oiseau3.png"
    ],
    papillon: [
      "assets/plants/papillon1.png",
      "assets/plants/papillon2.png",
      "assets/plants/papillon3.png"
    ]
  };

  // üé® LISTE DE BACKGROUNDS AL√âATOIRES
  const backgrounds = [
    "assets/bg-paper.jpg",
    "assets/bg1.jpg",
    "assets/bg2.jpg",
    "assets/bg3.jpg",
    "assets/bg4.jpg"
  ];

  let data = [];
  let currentPage = 0;
  let sessionWatered = {}; // Track quelles plantes ont √©t√© arros√©es cette session

  // Choisir un background al√©atoire au chargement
  function setRandomBackground() {
    const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBg}')`;
  }

  window.checkPassword = function() {
      if (pwd.value === PASSWORD) {
          login.style.display = "none";
          main.style.display = "block";
          quote.innerText = quotes[Math.floor(Math.random()*quotes.length)];
          setRandomBackground();
          loadPlants();
      }
  }

  window.openForm = function() {
      overlay.style.display = "flex";
  }

  function loadPlants() {
      onValue(plantsRef, (snapshot) => {
          data = [];
          snapshot.forEach((childSnapshot) => {
              const plant = childSnapshot.val();
              plant.firebaseId = childSnapshot.key;
              data.push(plant);
          });
          
          data.sort((a, b) => b.id - a.id);
          renderGarden();
      });
  }

  // üé≤ Choisir un type de plante al√©atoire
  function getRandomPlantType() {
    const types = ['arbre', 'arbuste', 'fleur', 'fruit', 'oiseau', 'papillon'];
    return types[Math.floor(Math.random() * types.length)];
  }

  // üìç Calculer la position selon le type
  function getPositionForType(type) {
    let x, y;
    
    switch(type) {
      case 'arbre':
      case 'arbuste':
        // Bas du jardin (60% √† 100% de hauteur)
        x = Math.random() * 85;
        y = 60 + Math.random() * 35;
        break;
        
      case 'fleur':
      case 'fruit':
        // Bas vers haut (30% √† 100% de hauteur - max 2/3)
        x = Math.random() * 85;
        y = 35 + Math.random() * 60;
        break;
        
      case 'oiseau':
      case 'papillon':
        // Haut vers bas (0% √† 66% de hauteur - max 2/3)
        x = Math.random() * 85;
        y = Math.random() * 66;
        break;
        
      default:
        x = Math.random() * 85;
        y = Math.random() * 75;
    }
    
    return { x, y };
  }

  // V√©rifier chevauchement
  function findNonOverlappingPosition(type) {
      const maxAttempts = 100;
      const minDistance = 12;
      
      for (let attempt = 0; attempt < maxAttempts; attempt++) {
          const pos = getPositionForType(type);
          
          let overlapping = false;
          for (let p of data) {
              const distance = Math.sqrt(
                  Math.pow(pos.x - p.x, 2) + Math.pow(pos.y - p.y, 2)
              );
              
              if (distance < minDistance) {
                  overlapping = true;
                  break;
              }
          }
          
          if (!overlapping) {
              return pos;
          }
      }
      
      return getPositionForType(type);
  }

  form.addEventListener("submit", e => {
      e.preventDefault();
      const f = new FormData(form);
      
      const type = getRandomPlantType();
      const position = findNonOverlappingPosition(type);
      const typeImages = plantTypes[type];
      const randomImg = typeImages[Math.floor(Math.random() * typeImages.length)];
      
      const newPlant = {
          id: Date.now(),
          activite: f.get("activite"),
          experience: f.get("experience"),
          ressenti: f.get("ressenti"),
          force: f.get("force") || f.get("forceLibre"),
          valeur: f.get("valeur"),
          pourQui: f.get("pourQui"),
          type: type,
          img: randomImg,
          x: position.x,
          y: position.y,
          eau: 0,
          soleil: 0,
          date: new Date().toLocaleDateString("fr-FR")
      };
      
      push(plantsRef, newPlant);
      
      overlay.style.display = "none";
      form.reset();
  });

  function renderGarden() {
      garden.innerHTML = "";
      
      if (data.length === 0) {
          garden.innerHTML = "<div class='loading'>üå± Le jardin est vide... Plante la premi√®re exp√©rience !</div>";
          return;
      }
      
      data.forEach((p, i) => {
          const img = document.createElement("img");
          img.src = p.img;
          img.className = `plant ${p.type || 'fleur'}` + (i === 0 ? " latest" : "");
          
          // Croissance limit√©e √† 150%
          const growthFactor = Math.min((p.eau || 0) + (p.soleil || 0), 5);
          const scale = 1 + growthFactor * 0.1; // Max 1.5 (150%)
          const baseSize = 90;
          const size = Math.min(baseSize * scale, baseSize * 1.5);
          
          img.style.width = size + "px";
          img.style.left = p.x + "%";
          img.style.top = p.y + "%";
          img.style.setProperty('--scale', scale);
          
          img.onclick = () => openNotebook(i);
          
          garden.appendChild(img);
      });
  }

  window.openNotebook = function(index) {
      currentPage = index;
      renderNotebook();
      notebook.classList.add("open");
  }

  window.closeNotebook = function() {
      notebook.classList.remove("open");
  }

  // üíß Arroser depuis la fiche
  window.waterPlant = function(plantId, type) {
      const sessionKey = `${plantId}_${type}`;
      
      if (sessionWatered[sessionKey]) {
          return; // D√©j√† arros√© cette session
      }
      
      const plant = data.find(p => p.firebaseId === plantId);
      if (!plant) return;
      
      if (type === 'water') {
          plant.eau = (plant.eau || 0) + 1;
      } else {
          plant.soleil = (plant.soleil || 0) + 1;
      }
      
      // Marquer comme utilis√©
      sessionWatered[sessionKey] = true;
      
      // Mettre √† jour Firebase
      const plantRef = ref(database, 'plants/' + plantId);
      update(plantRef, { eau: plant.eau, soleil: plant.soleil });
      
      // Re-render
      renderNotebook();
      renderGarden();
  }

  function renderNotebook() {
      if (data.length === 0) {
          notebookContent.innerHTML = "<p style='text-align:center; padding:40px;'>Aucune exp√©rience plant√©e pour l'instant...</p>";
          return;
      }
      
      const p = data[currentPage];
      const waterKey = `${p.firebaseId}_water`;
      const sunKey = `${p.firebaseId}_sun`;
      
      notebookContent.innerHTML = `
          <div class="notebook-page">
              <div class="page-header">
                  <div class="page-date">üìÖ ${p.date}</div>
                  <div class="page-number">Page ${currentPage + 1}/${data.length}</div>
              </div>
              
              <div class="notebook-section">
                  <div class="section-label">üåç Contexte</div>
                  <div class="section-content">${p.activite || "‚Äî"}</div>
              </div>
              
              <div class="notebook-section">
                  <div class="section-label">‚ú® Exp√©rience v√©cue</div>
                  <div class="section-content">${p.experience || "‚Äî"}</div>
              </div>
              
              ${p.ressenti ? `
              <div class="notebook-section">
                  <div class="section-label">üí≠ Ressenti & transformation</div>
                  <div class="section-content">${p.ressenti}</div>
              </div>
              ` : ''}
              
              ${p.force ? `
              <div class="notebook-section">
                  <div class="section-label">üí™ Force mobilis√©e</div>
                  <div class="section-content">${p.force}</div>
              </div>
              ` : ''}
              
              ${p.valeur ? `
              <div class="notebook-section">
                  <div class="section-label">‚≠ê Valeur en jeu</div>
                  <div class="section-content">${p.valeur}</div>
              </div>
              ` : ''}
              
              ${p.pourQui ? `
              <div class="notebook-section">
                  <div class="section-label">üë• Pour qui</div>
                  <div class="section-content">${p.pourQui}</div>
              </div>
              ` : ''}
              
              <div class="interaction-stats">
                  <div class="stat-item">üíß Eau : ${p.eau || 0}</div>
                  <div class="stat-item">‚òÄÔ∏è Soleil : ${p.soleil || 0}</div>
                  <div class="stat-item">üå± Croissance : ${Math.min(Math.round((1 + ((p.eau || 0) + (p.soleil || 0)) * 0.1) * 100), 150)}%</div>
              </div>
              
              <div class="water-actions">
                  <button class="water-btn ${sessionWatered[waterKey] ? 'used' : ''}" 
                          onclick="waterPlant('${p.firebaseId}', 'water')"
                          ${sessionWatered[waterKey] ? 'disabled' : ''}>
                      üíß
                  </button>
                  <button class="water-btn ${sessionWatered[sunKey] ? 'used' : ''}" 
                          onclick="waterPlant('${p.firebaseId}', 'sun')"
                          ${sessionWatered[sunKey] ? 'disabled' : ''}>
                      ‚òÄÔ∏è
                  </button>
              </div>
          </div>
      `;
      
      updatePageNav();
  }

  function updatePageNav() {
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage === data.length - 1;
      pageInfo.textContent = `${currentPage + 1} / ${data.length}`;
  }

  window.prevPage = function() {
      if (currentPage > 0) {
          currentPage--;
          renderNotebook();
      }
  }

  window.nextPage = function() {
      if (currentPage < data.length - 1) {
          currentPage++;
          renderNotebook();
      }
  }
</script>

</body>
</html>
